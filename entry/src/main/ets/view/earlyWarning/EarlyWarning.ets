import request from '../../utils/httpUtils'
import promptAction from '@ohos.promptAction'

interface ApiResult {
  success: boolean
  message?: string
  data?: any
}

interface AlarmItem {
  alarmId: string
  structureName: string
  fabricateName: string
  detectionType: string
  alarmLevel: string
  alarmContent: string
  alarmTime: string
  updateTime: string
  status: number
}

interface AlarmListResult {
  total: number
  rows: AlarmItem[]
}

@Component
export struct EarlyWarning {
  @Link currentTab: string
  @State alarmList: AlarmItem[] = []
  @State loading: boolean = false
  @State refreshing: boolean = false
  @State filterStatus: number = -1 // -1: å…¨éƒ¨, 0: æœªå¤„ç†, 1: å·²å¤„ç†
  @State filterLevel: string = 'å…¨éƒ¨'
  @State selectedAlarm: AlarmItem | null = null
  @State showDialog: boolean = false
  @State filteredCount: number = 0 // æ·»åŠ ç­›é€‰ç»“æžœè®¡æ•°

  aboutToAppear() {
    console.info('EarlyWarning ç»„ä»¶åˆå§‹åŒ–')
    this.initializeMockAlarms()
    this.loadAlarmList()
  }

  initializeMockAlarms() {
    this.alarmList = [
      {
        alarmId: 'ALARM_001_2024090215491',
        structureName: 'å—äº¬é•¿æ±Ÿå¤§æ¡¥',
        fabricateName: 'LA-1',
        detectionType: 'åº”åŠ›',
        alarmLevel: '3çº§',
        alarmContent: 'ä¼ æ„Ÿå™¨æµ‹é‡å€¼è¶…è¿‡3çº§å‘Šè­¦é˜ˆå€¼:è½¦é‡é‡‡é›†å€¼:52.1T,è¶…3çº§é˜ˆå€¼[50.0~75.0]',
        alarmTime: '2024-09-02T15:49:11',
        updateTime: '2024-09-02T15:49:24',
        status: 0
      },
      {
        alarmId: 'ALARM_002_2024090215543',
        structureName: 'é«˜é‚®æ¹–å¤§æ¡¥',
        fabricateName: 'LB-2',
        detectionType: 'ç´¢åŠ›',
        alarmLevel: '2çº§',
        alarmContent: 'ä¼ æ„Ÿå™¨æµ‹é‡å€¼è¶…è¿‡2çº§å‘Šè­¦é˜ˆå€¼:ç´¢åŠ›é‡‡é›†å€¼:180kN,è¶…2çº§é˜ˆå€¼[150.0~200.0]',
        alarmTime: '2024-09-02T15:54:38',
        updateTime: '2024-09-02T15:54:36',
        status: 1
      },
      {
        alarmId: 'ALARM_003_2024090310234',
        structureName: 'è‹é€šé•¿æ±Ÿå¤§æ¡¥',
        fabricateName: 'LC-3',
        detectionType: 'ä½ç§»',
        alarmLevel: '3çº§',
        alarmContent: 'ç»“æž„ä½ç§»å¼‚å¸¸:ä½ç§»å€¼:15.8mm,è¶…3çº§é˜ˆå€¼[15.0~20.0]',
        alarmTime: '2024-09-03T10:23:45',
        updateTime: '2024-09-03T10:23:45',
        status: 0
      },
      {
        alarmId: 'ALARM_004_2024090516552',
        structureName: 'æ¶¦æ‰¬é•¿æ±Ÿå¤§æ¡¥',
        fabricateName: 'LB-5',
        detectionType: 'ç´¢åŠ›',
        alarmLevel: '1çº§',
        alarmContent: 'ç´¢åŠ›è½»å¾®åå·®:ç´¢åŠ›å€¼:1180kN,æŽ¥è¿‘1çº§é˜ˆå€¼[1150~1250]',
        alarmTime: '2024-09-05T16:55:28',
        updateTime: '2024-09-05T17:02:45',
        status: 1
      },
      {
        alarmId: 'ALARM_005_2024090618321',
        structureName: 'æ³°å·žé•¿æ±Ÿå¤§æ¡¥',
        fabricateName: 'LD-4',
        detectionType: 'æ¸©åº¦',
        alarmLevel: '3çº§',
        alarmContent: 'ç»“æž„æ¸©åº¦å¼‚å¸¸:æ¸©åº¦å€¼:65.2â„ƒ,è¶…3çº§é˜ˆå€¼[60.0~70.0]',
        alarmTime: '2024-09-06T18:32:15',
        updateTime: '2024-09-06T18:32:15',
        status: 0
      },
      {
        alarmId: 'ALARM_006_2024090712456',
        structureName: 'æ±Ÿé˜´é•¿æ±Ÿå¤§æ¡¥',
        fabricateName: 'LE-6',
        detectionType: 'æŒ¯åŠ¨',
        alarmLevel: '2çº§',
        alarmContent: 'æŒ¯åŠ¨é¢‘çŽ‡è¶…æ ‡:é¢‘çŽ‡å€¼:2.8Hz,è¶…2çº§é˜ˆå€¼[2.5~3.0]',
        alarmTime: '2024-09-07T12:45:32',
        updateTime: '2024-09-07T13:02:18',
        status: 1
      }
    ]

    console.info('æ¨¡æ‹Ÿæ•°æ®åˆå§‹åŒ–å®Œæˆï¼Œé¢„è­¦æ•°é‡:', this.alarmList.length)
    this.updateFilteredCount()
  }

  // æ›´æ–°ç­›é€‰è®¡æ•°
  private updateFilteredCount() {
    this.filteredCount = this.getFilteredAlarmList().length
    console.info(`ç­›é€‰æ›´æ–°: çŠ¶æ€=${this.filterStatus}, çº§åˆ«=${this.filterLevel}, ç»“æžœæ•°=${this.filteredCount}`)
  }

  async loadAlarmList() {
    this.loading = true
    try {
      console.info('å¼€å§‹åŠ è½½é¢„è­¦åˆ—è¡¨...')
      let result = await request.post('/alarm/getList', {}) as ApiResult
      console.info('é¢„è­¦åˆ—è¡¨APIå“åº”:', JSON.stringify(result, null, 2))

      if (result?.success && result?.data) {
        let alarmData = result.data as AlarmListResult
        console.info('è§£æžåŽçš„é¢„è­¦æ•°æ®:', JSON.stringify(alarmData, null, 2))

        if (alarmData?.rows && alarmData.rows.length > 0) {
          this.alarmList = alarmData.rows.map((item, index) => {
            console.info(`å¤„ç†ç¬¬${index + 1}æ¡é¢„è­¦æ•°æ®:`, JSON.stringify(item, null, 2))
            let processedItem = {
              alarmId: item.alarmId || '',
              structureName: item.structureName || 'æœªçŸ¥ç»“æž„ç‰©',
              fabricateName: item.fabricateName || 'æœªçŸ¥æž„ä»¶',
              detectionType: item.detectionType || 'æœªçŸ¥ç±»åž‹',
              alarmLevel: item.alarmLevel || '1çº§',
              alarmContent: item.alarmContent || 'æš‚æ— è¯¦ç»†ä¿¡æ¯',
              alarmTime: item.alarmTime || new Date().toISOString(),
              updateTime: item.updateTime || new Date().toISOString(),
              status: typeof item.status === 'number' ? item.status : 0
            }
            console.info(`å¤„ç†åŽçš„ç¬¬${index + 1}æ¡æ•°æ®:`, JSON.stringify(processedItem, null, 2))
            return processedItem
          })
          console.info('é¢„è­¦åˆ—è¡¨åŠ è½½æˆåŠŸï¼Œæ•°é‡:', this.alarmList.length)
          this.updateFilteredCount()
        } else {
          console.warn('APIè¿”å›žç©ºæ•°æ®ï¼Œä¿ç•™æ¨¡æ‹Ÿæ•°æ®')
        }
      } else {
        console.warn('APIè°ƒç”¨å¤±è´¥ï¼Œä¿ç•™æ¨¡æ‹Ÿæ•°æ®:', result?.message)
      }
    } catch (error) {
      console.error('åŠ è½½é¢„è­¦åˆ—è¡¨å¤±è´¥:', error)
      promptAction.showToast({
        message: 'ç½‘ç»œå¼‚å¸¸ï¼Œæ˜¾ç¤ºæœ¬åœ°æ•°æ®',
        duration: 2000,
      })
    } finally {
      this.loading = false
      this.refreshing = false
    }
  }

  async handleAlarm(alarmId: string) {
    if (!alarmId || alarmId.trim() === '') {
      console.error('é¢„è­¦IDä¸ºç©º:', alarmId)
      promptAction.showToast({
        message: 'é¢„è­¦IDæ— æ•ˆï¼Œè¯·é‡è¯•',
        duration: 2000,
      })
      return
    }

    console.info('å¼€å§‹å¤„ç†é¢„è­¦ï¼ŒID:', alarmId)

    try {
      let requestParams = {
        alarmId: alarmId.trim()
      }

      console.info('è¯·æ±‚å‚æ•°:', JSON.stringify(requestParams, null, 2))

      let result = await request.post('/alarm/handle', requestParams) as ApiResult

      console.info('å¤„ç†é¢„è­¦å“åº”:', JSON.stringify(result, null, 2))

      if (result?.success) {
        promptAction.showToast({
          message: 'é¢„è­¦å¤„ç†æˆåŠŸ',
          duration: 2000,
        })

        let index = this.alarmList.findIndex(item => item.alarmId === alarmId)
        if (index !== -1) {
          this.alarmList[index].status = 1
          this.alarmList[index].updateTime = new Date().toISOString()
          console.info('æœ¬åœ°æ•°æ®å·²æ›´æ–°ï¼Œç´¢å¼•:', index)
          this.updateFilteredCount() // æ›´æ–°ç­›é€‰è®¡æ•°
        }
        this.showDialog = false
      } else {
        console.error('å¤„ç†é¢„è­¦å¤±è´¥ï¼ŒåŽŸå› :', result?.message)
        promptAction.showToast({
          message: result?.message || 'å¤„ç†å¤±è´¥',
          duration: 2000,
        })
      }
    } catch (error) {
      console.error('å¤„ç†é¢„è­¦å¼‚å¸¸:', error)
      promptAction.showToast({
        message: 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åŽé‡è¯•',
        duration: 2000,
      })
    }
  }

  getFilteredAlarmList(): AlarmItem[] {
    return this.alarmList.filter(item => {
      let statusMatch = this.filterStatus === -1 || item.status === this.filterStatus
      let levelMatch = this.filterLevel === 'å…¨éƒ¨' || item.alarmLevel === this.filterLevel
      return statusMatch && levelMatch
    })
  }

  getAlarmLevelColor(level: string): string {
    switch (level) {
      case '1çº§': return '#52c41a'
      case '2çº§': return '#faad14'
      case '3çº§': return '#f5222d'
      default: return '#1890ff'
    }
  }

  getStatusText(status: number): string {
    return status === 0 ? 'æœªå¤„ç†' : 'å·²å¤„ç†'
  }

  getStatusColor(status: number): string {
    return status === 0 ? '#f5222d' : '#52c41a'
  }

  formatDateTime(dateStr: string): string {
    if (!dateStr) return 'æœªçŸ¥æ—¶é—´'
    try {
      let date = new Date(dateStr)
      if (isNaN(date.getTime())) return dateStr
      return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`
    } catch {
      return dateStr
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('é¢„è­¦ç®¡ç†')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')

        Blank()

        Button('åˆ·æ–°')
          .fontSize(14)
          .backgroundColor('#4852C9')
          .onClick(() => {
            console.info('ç”¨æˆ·ç‚¹å‡»é¢„è­¦åˆ·æ–°æŒ‰é’®')
            this.refreshing = true
            this.loadAlarmList()
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor('#f8f9fa')

      // ç­›é€‰å™¨ - æ”¹è¿›å¸ƒå±€å’Œäº¤äº’
      Column() {
        // çŠ¶æ€ç­›é€‰
        Row() {
          Text('çŠ¶æ€ç­›é€‰:')
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .margin({ right: 12 })

          ForEach([
            { label: 'å…¨éƒ¨', value: -1 },
            { label: 'æœªå¤„ç†', value: 0 },
            { label: 'å·²å¤„ç†', value: 1 }
          ], (item: { label: string, value: number }) => {
            Text(item.label)
              .fontSize(12)
              .fontColor(this.filterStatus === item.value ? '#fff' : '#666')
              .fontWeight(this.filterStatus === item.value ? FontWeight.Bold : FontWeight.Normal)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .backgroundColor(this.filterStatus === item.value ? '#4852C9' : '#f0f0f0')
              .borderRadius(16)
              .onClick(() => {
                console.info(`åˆ‡æ¢çŠ¶æ€ç­›é€‰: ${item.label} (${item.value})`)
                this.filterStatus = item.value
                this.updateFilteredCount()
              })
              .margin({ right: 8 })
          })
        }
        .width('100%')
        .margin({ bottom: 12 })

        // çº§åˆ«ç­›é€‰
        Row() {
          Text('çº§åˆ«ç­›é€‰:')
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .margin({ right: 12 })

          ForEach(['å…¨éƒ¨', '1çº§', '2çº§', '3çº§'], (level: string) => {
            Text(level)
              .fontSize(12)
              .fontColor(this.filterLevel === level ? '#fff' : '#666')
              .fontWeight(this.filterLevel === level ? FontWeight.Bold : FontWeight.Normal)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .backgroundColor(this.filterLevel === level ? this.getLevelFilterColor(level) : '#f0f0f0')
              .borderRadius(16)
              .onClick(() => {
                console.info(`åˆ‡æ¢çº§åˆ«ç­›é€‰: ${level}`)
                this.filterLevel = level
                this.updateFilteredCount()
              })
              .margin({ right: 8 })
          })
        }
        .width('100%')

        // ç­›é€‰ç»“æžœæç¤º
        Row() {
          Text(`ç­›é€‰ç»“æžœ: ${this.filteredCount} æ¡é¢„è­¦`)
            .fontSize(12)
            .fontColor('#666')
            .margin({ top: 8 })

          Blank()

          if (this.filterStatus !== -1 || this.filterLevel !== 'å…¨éƒ¨') {
            Text('æ¸…é™¤ç­›é€‰')
              .fontSize(12)
              .fontColor('#4852C9')
              .onClick(() => {
                this.filterStatus = -1
                this.filterLevel = 'å…¨éƒ¨'
                this.updateFilteredCount()
              })
          }
        }
        .width('100%')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor(Color.White)
      .border({
        width: { bottom: 1 },
        color: '#f0f0f0'
      })

      // ç»Ÿè®¡ä¿¡æ¯
      Row() {
        this.StatCard('æ€»é¢„è­¦', this.alarmList.length, '#1890ff')
        this.StatCard('æœªå¤„ç†', this.alarmList.filter(item => item.status === 0).length, '#f5222d')
        this.StatCard('å·²å¤„ç†', this.alarmList.filter(item => item.status === 1).length, '#52c41a')
        this.StatCard('3çº§é¢„è­¦', this.alarmList.filter(item => item.alarmLevel === '3çº§').length, '#ff4d4f')
      }
      .width('100%')
      .padding(16)
      .justifyContent(FlexAlign.SpaceBetween)
      .backgroundColor('#f8f9fa')

      // ä¸»è¦å†…å®¹åŒºåŸŸ - ä¿®å¤æ»šåŠ¨é—®é¢˜
      if (this.loading && !this.refreshing) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#4852C9')

          Text('åŠ è½½é¢„è­¦æ•°æ®ä¸­...')
            .fontSize(14)
            .fontColor('#666')
            .margin({ top: 8 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        // é¢„è­¦åˆ—è¡¨ - ä¼˜åŒ–å¸ƒå±€
        Refresh({ refreshing: this.refreshing, offset: 50, friction: 66 }) {
          if (this.getFilteredAlarmList().length === 0) {
            // ç©ºçŠ¶æ€
            Column() {
              Text('ðŸ“‹')
                .fontSize(60)
                .opacity(0.3)

              Text('æš‚æ— é¢„è­¦æ•°æ®')
                .fontSize(16)
                .fontColor('#999')
                .margin({ top: 16 })

              if (this.filterStatus !== -1 || this.filterLevel !== 'å…¨éƒ¨') {
                Text('å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ— æ•°æ®ï¼Œè¯·è°ƒæ•´ç­›é€‰æ¡ä»¶')
                  .fontSize(12)
                  .fontColor('#ccc')
                  .margin({ top: 8 })

                Button('æ¸…é™¤ç­›é€‰')
                  .fontSize(14)
                  .backgroundColor('#4852C9')
                  .margin({ top: 16 })
                  .onClick(() => {
                    this.filterStatus = -1
                    this.filterLevel = 'å…¨éƒ¨'
                    this.updateFilteredCount()
                  })
              } else {
                Text('è¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥æˆ–ç¨åŽé‡è¯•')
                  .fontSize(12)
                  .fontColor('#ccc')
                  .margin({ top: 8 })
              }
            }
            .width('100%')
            .height('100%')
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
          } else {
            // æœ‰æ•°æ®æ—¶æ˜¾ç¤ºåˆ—è¡¨
            List({ space: 8 }) {
              ForEach(this.getFilteredAlarmList(), (alarm: AlarmItem, index: number) => {
                ListItem() {
                  this.AlarmItemView(alarm, index)
                }
              })

              // æ·»åŠ åº•éƒ¨é—´è·ï¼Œç¡®ä¿æœ€åŽä¸€é¡¹å¯ä»¥å®Œå…¨æ˜¾ç¤º
              ListItem() {
                Column()
                  .width('100%')
                  .height(80)
              }
            }
            .width('100%')
            .height('100%')
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .scrollBar(BarState.Auto)
            .edgeEffect(EdgeEffect.Spring)
          }
        }
        .onRefreshing(() => {
          this.loadAlarmList()
        })
        .layoutWeight(1)
      }

      // é¢„è­¦è¯¦æƒ…å¯¹è¯æ¡†
      if (this.showDialog && this.selectedAlarm) {
        this.AlarmDetailDialog()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  // èŽ·å–çº§åˆ«ç­›é€‰æŒ‰é’®é¢œè‰²
  private getLevelFilterColor(level: string): string {
    switch (level) {
      case '1çº§': return '#52c41a'
      case '2çº§': return '#faad14'
      case '3çº§': return '#f5222d'
      default: return '#4852C9'
    }
  }

  @Builder
  StatCard(title: string, count: number, color: string) {
    Column() {
      Text(count.toString())
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(12)
        .fontColor('#666')
        .margin({ top: 4 })
    }
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .width(80)
    .shadow({
      radius: 2,
      color: '#00000010',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  AlarmItemView(alarm: AlarmItem, index: number) {
    Column() {
      // å¤´éƒ¨ä¿¡æ¯
      Row() {
        Row() {
          Circle({ width: 8, height: 8 })
            .fill(this.getAlarmLevelColor(alarm.alarmLevel))
            .margin({ right: 6 })

          Text(alarm.alarmLevel || 'æœªçŸ¥çº§åˆ«')
            .fontSize(12)
            .fontColor(this.getAlarmLevelColor(alarm.alarmLevel))
            .fontWeight(FontWeight.Bold)
        }

        Blank()

        Row() {
          Text('#' + (index + 1))
            .fontSize(10)
            .fontColor('#999')
            .margin({ right: 8 })

          Text(this.getStatusText(alarm.status))
            .fontSize(12)
            .fontColor(this.getStatusColor(alarm.status))
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .backgroundColor(alarm.status === 0 ? '#fff2f0' : '#f6ffed')
            .borderRadius(10)
        }
      }
      .width('100%')
      .margin({ bottom: 8 })

      // ç»“æž„ç‰©ä¿¡æ¯
      Row() {
        Text(alarm.structureName || 'æœªçŸ¥ç»“æž„ç‰©')
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        if (alarm.fabricateName) {
          Text(' - ' + alarm.fabricateName)
            .fontSize(12)
            .fontColor('#666666')
        }

        Blank()

        Text(alarm.detectionType || 'æœªçŸ¥ç±»åž‹')
          .fontSize(12)
          .fontColor('#1890ff')
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .backgroundColor('#e6f7ff')
          .borderRadius(10)
      }
      .width('100%')
      .margin({ bottom: 8 })

      // é¢„è­¦å†…å®¹
      Text(alarm.alarmContent || 'æš‚æ— è¯¦ç»†ä¿¡æ¯')
        .fontSize(13)
        .fontColor('#333333')
        .lineHeight(18)
        .width('100%')
        .margin({ bottom: 8 })
        .padding(8)
        .backgroundColor('#f8f9fa')
        .borderRadius(6)
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })

      // æ—¶é—´å’Œæ“ä½œ
      Row() {
        Column() {
          Text('é¢„è­¦æ—¶é—´: ' + this.formatDateTime(alarm.alarmTime))
            .fontSize(11)
            .fontColor('#999999')

          if (alarm.updateTime) {
            Text('æ›´æ–°æ—¶é—´: ' + this.formatDateTime(alarm.updateTime))
              .fontSize(11)
              .fontColor('#999999')
              .margin({ top: 2 })
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        Row() {
          Button('è¯¦æƒ…')
            .fontSize(12)
            .backgroundColor('#f0f0f0')
            .fontColor('#666')
            .padding({ left: 16, right: 16, top: 6, bottom: 6 })
            .constraintSize({ minWidth: 60 })
            .onClick(() => {
              this.selectedAlarm = alarm
              this.showDialog = true
            })

          if (alarm.status === 0) {
            Button('å¤„ç†')
              .fontSize(12)
              .backgroundColor('#4852C9')
              .fontColor(Color.White)
              .padding({ left: 16, right: 16, top: 6, bottom: 6 })
              .constraintSize({ minWidth: 60 })
              .margin({ left: 8 })
              .onClick(() => {
                console.info('ç‚¹å‡»å¤„ç†æŒ‰é’®ï¼Œé¢„è­¦ä¿¡æ¯:', alarm)

                if (!alarm.alarmId || alarm.alarmId.trim() === '') {
                  console.error('é¢„è­¦IDæ— æ•ˆ:', alarm.alarmId)
                  promptAction.showToast({
                    message: 'é¢„è­¦æ•°æ®å¼‚å¸¸ï¼Œè¯·åˆ·æ–°åŽé‡è¯•',
                    duration: 2000,
                  })
                  return
                }

                this.handleAlarm(alarm.alarmId)
              })
          }
        }
      }
      .width('100%')
      .alignItems(VerticalAlign.Bottom)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: '#00000008',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      this.selectedAlarm = alarm
      this.showDialog = true
    })
  }

  @Builder
  AlarmDetailDialog() {
    if (this.selectedAlarm) {
      // å…¨å±é®ç½©
      Stack() {
        // èƒŒæ™¯é®ç½©
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0,0,0,0.5)')
          .onClick(() => {
            this.showDialog = false
          })

        // å¯¹è¯æ¡†å†…å®¹
        Column() {
          // æ ‡é¢˜æ 
          Row() {
            Text('é¢„è­¦è¯¦æƒ…')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')

            Blank()

            Button('âœ•')
              .fontSize(16)
              .backgroundColor(Color.Transparent)
              .fontColor('#999')
              .padding(8)
              .onClick(() => {
                this.showDialog = false
              })
          }
          .width('100%')
          .padding({ bottom: 16 })

          // å†…å®¹åŒºåŸŸ
          Scroll() {
            Column() {
              this.DetailRow('é¢„è­¦ID', this.selectedAlarm.alarmId)
              this.DetailRow('ç»“æž„ç‰©', this.selectedAlarm.structureName)
              this.DetailRow('æž„ä»¶', this.selectedAlarm.fabricateName)
              this.DetailRow('ç›‘æµ‹ç±»åž‹', this.selectedAlarm.detectionType)
              this.DetailRow('é¢„è­¦çº§åˆ«', this.selectedAlarm.alarmLevel, this.getAlarmLevelColor(this.selectedAlarm.alarmLevel))
              this.DetailRow('çŠ¶æ€', this.getStatusText(this.selectedAlarm.status), this.getStatusColor(this.selectedAlarm.status))
              this.DetailRow('é¢„è­¦æ—¶é—´', this.formatDateTime(this.selectedAlarm.alarmTime))
              this.DetailRow('æ›´æ–°æ—¶é—´', this.formatDateTime(this.selectedAlarm.updateTime))

              Column() {
                Text('é¢„è­¦å†…å®¹')
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#333')
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })

                Text(this.selectedAlarm.alarmContent)
                  .fontSize(14)
                  .fontColor('#666')
                  .lineHeight(20)
                  .width('100%')
                  .padding(12)
                  .backgroundColor('#f8f9fa')
                  .borderRadius(8)
              }
              .width('100%')
              .margin({ top: 16 })
            }
          }
          .layoutWeight(1)
          .scrollBar(BarState.Auto)

          // æ“ä½œæŒ‰é’®
          if (this.selectedAlarm.status === 0) {
            Row() {
              Button('å–æ¶ˆ')
                .fontSize(14)
                .backgroundColor('#f0f0f0')
                .fontColor('#666')
                .layoutWeight(1)
                .onClick(() => {
                  this.showDialog = false
                })

              Button('æ ‡è®°ä¸ºå·²å¤„ç†')
                .fontSize(14)
                .backgroundColor('#4852C9')
                .fontColor(Color.White)
                .layoutWeight(1)
                .margin({ left: 12 })
                .onClick(() => {
                  this.handleAlarm(this.selectedAlarm!.alarmId)
                })
            }
            .width('100%')
            .margin({ top: 16 })
          } else {
            Button('å…³é—­')
              .fontSize(14)
              .backgroundColor('#4852C9')
              .fontColor(Color.White)
              .width('100%')
              .margin({ top: 16 })
              .onClick(() => {
                this.showDialog = false
              })
          }
        }
        .width('90%')
        .constraintSize({ maxHeight: '80%' })
        .padding(20)
        .backgroundColor(Color.White)
        .borderRadius(16)
        .shadow({
          radius: 20,
          color: '#00000020',
          offsetX: 0,
          offsetY: 10
        })
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 })
      .zIndex(999)
    }
  }

  @Builder
  DetailRow(label: string, value: string, color?: string) {
    Row() {
      Text(label + ':')
        .fontSize(14)
        .fontColor('#333')
        .fontWeight(FontWeight.Bold)
        .width(80)

      Text(value || 'æš‚æ— ')
        .fontSize(14)
        .fontColor(color || '#666')
        .layoutWeight(1)
        .textAlign(TextAlign.Start)
    }
    .width('100%')
    .padding({ top: 8, bottom: 8 })
    .alignItems(VerticalAlign.Center)
  }
}
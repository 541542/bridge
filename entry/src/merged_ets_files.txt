
============================================================
æ–‡ä»¶: main\ets\pages\Home.ets
============================================================

import {DataStatistics} from '../view/dataStatistics/DataStatistics'
import {EarlyWarning} from '../view/earlyWarning/EarlyWarning'

@Entry
@Component
struct Home {
  @State currentTab: string = 'æ•°æ®ç»Ÿè®¡'

  build() {
    Column() {
      Tabs({ barPosition: BarPosition.End }) {
        TabContent() {
          DataStatistics()
        }
        .tabBar(this.TabBuilder({
          label: 'æ•°æ®ç»Ÿè®¡',
          active: $r('app.media.statistics_active'),
          primary: $r('app.media.statistics_primary')
        }))

        TabContent() {
          EarlyWarning({ currentTab: $currentTab })
        }
        .tabBar(this.TabBuilder({
          label: 'é¢„è­¦ç®¡ç†',
          active: $r('app.media.warning_active'),
          primary: $r('app.media.warning_primary')
        }))
      }
      .scrollable(false)
      .vertical(false)
      .onChange((index: number) => {
        this.currentTab = index == 0 ? 'æ•°æ®ç»Ÿè®¡' : 'é¢„è­¦ç®¡ç†'
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  TabBuilder(params) {
    Column() {
      Image(this.currentTab == params.label ? params.active : params.primary)
        .width(22)
        .height(22)
        .margin({bottom:2})
      Text(params.label)
        .fontColor(this.currentTab == params.label ? $r('app.color.activeColor') : $r('app.color.primaryColor'))
        .fontSize(12)
    }
    .padding({ top: 8, bottom: 8 })
  }
}


============================================================
æ–‡ä»¶: main\ets\pages\Index.ets
============================================================




============================================================
æ–‡ä»¶: main\ets\pages\Login.ets
============================================================

import {LoginTab} from '../view/login/LoginTab';

@Entry
@Component
struct Login {
  build() {
    Column() {
      LoginTab()
      Text('æŠ€æœ¯æ”¯æŒ ä¸­è½¯å›½é™…æ•™è‚²ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸')
        .fontColor('#fff').fontSize(10).offset({ y: 80 })
    }
    .justifyContent(FlexAlign.SpaceAround)
    .backgroundImage($r('app.media.bg'))
    .backgroundImageSize({ width: '100%', height: '100%' })
    .width('100%').height('100%')
  }
}



============================================================
æ–‡ä»¶: main\ets\pages\test.ets
============================================================




============================================================
æ–‡ä»¶: main\ets\utils\httpUtils.ets
============================================================

import http from '@ohos.net.http';
import promptAction from '@ohos.promptAction';

//æµ‹è¯•ç¯å¢ƒæœåŠ¡å™¨
const baseUrl = 'http://10.18.18.230:8081/api'

const request = {
  post(url, params) {
    let bhmToken = '';
    if (url.includes('/login')) {
      bhmToken = '';
    } else {
      bhmToken = AppStorage.Get('bhm-token');
    }
    return new Promise((resolve, reject) => {
      let httpRequest = http.createHttp();
      let promise = httpRequest.request(baseUrl + url, {
        method: http.RequestMethod.POST,
        connectTimeout: 600000,
        readTimeout: 1000000,
        header: {
          'Content-Type': 'application/json',
          'bhm-token': bhmToken
        },
        expectDataType: http.HttpDataType.OBJECT,
        extraData: params
      });
      promise.then((data) => {
        if (data.responseCode == 200) {
          resolve(data.result)
        } else {
          promptAction.showToast({
            message: 'ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨å¾®é‡è¯•',
            duration: 2000,
          });
          reject(data.responseCode)
        }
      }).catch((err) => {
        reject(err)
        console.info('error:' + JSON.stringify(err));
      });
    })
  },
  get(url) {
    let bhmToken = '';
    if (url.includes('/login')) {
      bhmToken = '';
    } else {
      bhmToken = AppStorage.Get('bhm-token');
    }
    return new Promise((resolve, reject) => {
      let httpRequest = http.createHttp();
      let promise = httpRequest.request(baseUrl + url, {
        method: http.RequestMethod.GET,
        connectTimeout: 60000,
        readTimeout: 10000,
        header: {
          'Content-Type': 'application/json',
          'bhm-token': bhmToken
        },
        expectDataType: http.HttpDataType.OBJECT, // å¯é€‰ï¼ŒæŒ‡å®šè¿”å›æ•°æ®çš„ç±»å‹
      });
      promise.then((data) => {
        if (data.responseCode == 200) {
          resolve(data.result)

        } else {
          promptAction.showToast({
            message: 'ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨å¾®é‡è¯•',
            duration: 2000,
          });
          reject(data.responseCode)
        }
      }).catch((err) => {
        reject(err)
        console.info('error:' + JSON.stringify(err));
      });
    })
  },
}

export default request



============================================================
æ–‡ä»¶: main\ets\view\dataStatistics\DataStatistics.ets
============================================================

import request from '../../utils/httpUtils'

interface ApiResult {
  success: boolean
  message?: string
  data?: any
}

interface LineChartData {
  sensorName: string[]
  maxData: number[]
  minData: number[]
  avgData: number[]
  sensorType?: string
  sensorUnit?: string
  sensorTypeDesc?: string
  totalCount?: number
  validCount?: number
  dataQuality?: string
}

interface DistributionData {
  xData: string[]
  yData: number[]
  sensorType?: string
  sensorUnit?: string
  sensorTypeDesc?: string
  totalCount?: number
  analysisNote?: string
}

interface WarningData {
  fabricateName: string[]
  totalNum: number[]
  level1Num: number[]
  level2Num: number[]
  level3Num: number[]
  mom?: number[]
}

interface SensorTypeInfo {
  code: string
  name: string
  description: string
}

interface SensorTypeStats {
  [key: string]: number
}

@Component
export struct DataStatistics {
  @State currentChart: string = 'æŠ˜çº¿å›¾'
  @State lineChartData: LineChartData | null = null
  @State distributionData: DistributionData | null = null
  @State warningData: WarningData | null = null
  @State warningMonthData: WarningData | null = null
  @State loading: boolean = false
  @State currentPage: number = 0
  @State pageSize: number = 10

  // ä¼ æ„Ÿå™¨ç±»å‹ç›¸å…³çŠ¶æ€
  @State sensorTypes: SensorTypeInfo[] = []
  @State selectedSensorType: string = 'ALL'
  @State distributionSensorType: string = 'ALL' // æ•°æ®åˆ†å¸ƒé€‰æ‹©çš„ä¼ æ„Ÿå™¨ç±»å‹
  @State sensorTypeStats: SensorTypeStats = {}
  @State loadingSensorTypes: boolean = false
  @State loadingDistribution: boolean = false
  @State refreshing: boolean = false

  // Canvasç›¸å…³çŠ¶æ€
  private settings: RenderingContextSettings = new RenderingContextSettings(true)
  private context: CanvasRenderingContext2D = new CanvasRenderingContext2D(this.settings)
  private pieSettings: RenderingContextSettings = new RenderingContextSettings(true)
  private pieContext: CanvasRenderingContext2D = new CanvasRenderingContext2D(this.pieSettings)
  private warningSettings: RenderingContextSettings = new RenderingContextSettings(true)
  private warningContext: CanvasRenderingContext2D = new CanvasRenderingContext2D(this.warningSettings)
  private monthSettings: RenderingContextSettings = new RenderingContextSettings(true)
  private monthContext: CanvasRenderingContext2D = new CanvasRenderingContext2D(this.monthSettings)

  aboutToAppear() {
    console.info('DataStatistics ç»„ä»¶åˆå§‹åŒ–')
    this.initializeMockData()
    this.loadSensorTypes()
    this.loadAllData()
  }

  initializeMockData() {
    console.info('åˆå§‹åŒ–æ¨¡æ‹Ÿæ•°æ®')
    this.lineChartData = this.getMockLineChartData()
    this.distributionData = this.getMockDistributionData()
    this.warningData = this.getMockWarningData()
    this.warningMonthData = this.getMockWarningMonthData()
    console.info('æ¨¡æ‹Ÿæ•°æ®è®¾ç½®å®Œæˆ')
  }

  // =====================================
  // æ•°æ®åŠ è½½ç›¸å…³æ–¹æ³•
  // =====================================

  // åŠ è½½ä¼ æ„Ÿå™¨ç±»å‹åˆ—è¡¨
  async loadSensorTypes() {
    this.loadingSensorTypes = true
    try {
      console.info('å¼€å§‹åŠ è½½ä¼ æ„Ÿå™¨ç±»å‹åˆ—è¡¨...')

      let result = await request.get('/statistic/sensorTypes') as ApiResult

      if (result?.success && result?.data) {
        this.sensorTypes = result.data as SensorTypeInfo[]
        console.info('ä¼ æ„Ÿå™¨ç±»å‹åŠ è½½æˆåŠŸ:', this.sensorTypes)
      } else {
        console.warn('ä¼ æ„Ÿå™¨ç±»å‹APIè¿”å›æ— æ•ˆæ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®')
        this.sensorTypes = this.getDefaultSensorTypes()
      }

      // åŠ è½½ä¼ æ„Ÿå™¨ç±»å‹ç»Ÿè®¡
      await this.loadSensorTypeStats()

    } catch (error) {
      console.error('åŠ è½½ä¼ æ„Ÿå™¨ç±»å‹å¤±è´¥:', error)
      this.sensorTypes = this.getDefaultSensorTypes()
    } finally {
      this.loadingSensorTypes = false
    }
  }

  // åŠ è½½ä¼ æ„Ÿå™¨ç±»å‹ç»Ÿè®¡
  async loadSensorTypeStats() {
    try {
      let result = await request.get('/statistic/sensorTypeStats') as ApiResult

      if (result?.success && result?.data) {
        this.sensorTypeStats = result.data as SensorTypeStats
        console.info('ä¼ æ„Ÿå™¨ç±»å‹ç»Ÿè®¡åŠ è½½æˆåŠŸ:', this.sensorTypeStats)
      }
    } catch (error) {
      console.error('åŠ è½½ä¼ æ„Ÿå™¨ç±»å‹ç»Ÿè®¡å¤±è´¥:', error)
      this.sensorTypeStats = {
        'ALL': 26,
        'STRESS': 10,
        'CABLE_FORCE': 6,
        'DISPLACEMENT': 4,
        'VIBRATION': 3,
        'TEMPERATURE': 2,
        'WIND_SPEED': 1,
        'LOAD': 0,
        'OTHER': 0
      }
    }
  }

  // è·å–é»˜è®¤ä¼ æ„Ÿå™¨ç±»å‹
  getDefaultSensorTypes(): SensorTypeInfo[] {
    return [
      { code: 'ALL', name: 'å…¨éƒ¨ä¼ æ„Ÿå™¨', description: 'æ˜¾ç¤ºæ‰€æœ‰ç±»å‹ä¼ æ„Ÿå™¨' },
      { code: 'STRESS', name: 'åº”åŠ›ä¼ æ„Ÿå™¨', description: 'åº”åŠ›ç±»ä¼ æ„Ÿå™¨(MPa)' },
      { code: 'CABLE_FORCE', name: 'ç´¢åŠ›ä¼ æ„Ÿå™¨', description: 'ç´¢åŠ›ç±»ä¼ æ„Ÿå™¨(KN)' },
      { code: 'DISPLACEMENT', name: 'ä½ç§»ä¼ æ„Ÿå™¨', description: 'ä½ç§»ç±»ä¼ æ„Ÿå™¨(mm)' },
      { code: 'VIBRATION', name: 'æŒ¯åŠ¨ä¼ æ„Ÿå™¨', description: 'æŒ¯åŠ¨ç±»ä¼ æ„Ÿå™¨(Hz)' },
      { code: 'TEMPERATURE', name: 'æ¸©åº¦ä¼ æ„Ÿå™¨', description: 'æ¸©åº¦ç±»ä¼ æ„Ÿå™¨(â„ƒ)' },
      { code: 'WIND_SPEED', name: 'é£é€Ÿä¼ æ„Ÿå™¨', description: 'é£é€Ÿç±»ä¼ æ„Ÿå™¨(m/s)' },
      { code: 'LOAD', name: 'è·è½½ä¼ æ„Ÿå™¨', description: 'è·è½½ç±»ä¼ æ„Ÿå™¨(T)' },
      { code: 'OTHER', name: 'å…¶ä»–ä¼ æ„Ÿå™¨', description: 'å…¶ä»–ç±»å‹ä¼ æ„Ÿå™¨' }
    ]
  }

  async loadAllData() {
    this.loading = true
    try {
      console.info('å¼€å§‹åŠ è½½æ‰€æœ‰æ•°æ®...')

      let promiseResults = await Promise.all([
      this.loadLineChart(),
      this.loadDistribution(),
      this.loadWarningData(),
      this.loadWarningMonth()
      ])

      let [lineChart, distribution, warning, warningMonth] = promiseResults

      console.info('=== æ•°æ®éªŒè¯ç»“æœ ===')
      console.info('æŠ˜çº¿å›¾æ•°æ®éªŒè¯:', lineChart ? this.validateLineChartData(lineChart) : false)

      if (lineChart && this.validateLineChartData(lineChart)) {
        console.info('è®¾ç½®æŠ˜çº¿å›¾æ•°æ®ï¼Œä¼ æ„Ÿå™¨æ•°é‡:', lineChart.sensorName.length)
        this.lineChartData = lineChart
      } else {
        console.warn('æŠ˜çº¿å›¾æ•°æ®éªŒè¯å¤±è´¥ï¼Œä¿æŒåŸæœ‰æ•°æ®')
      }

      if (distribution && this.validateDistributionData(distribution)) {
        this.distributionData = distribution
      }
      if (warning && this.validateWarningData(warning)) {
        this.warningData = warning
      }
      if (warningMonth && this.validateWarningData(warningMonth)) {
        this.warningMonthData = warningMonth
      }

      console.info('=== æœ€ç»ˆæ•°æ®çŠ¶æ€ ===')
      console.info('æœ€ç»ˆlineChartDataä¼ æ„Ÿå™¨æ•°é‡:', this.lineChartData?.sensorName?.length)
      console.info('æ•°æ®è®¾ç½®å®Œæˆ')
    } catch (error) {
      console.error('åŠ è½½æ•°æ®å¤±è´¥:', error)
    } finally {
      this.loading = false
    }
  }

  // æ”¯æŒä¼ æ„Ÿå™¨ç±»å‹å‚æ•°çš„æŠ˜çº¿å›¾æ•°æ®åŠ è½½
  async loadLineChart(): Promise<LineChartData> {
    try {
      console.info('å¼€å§‹åŠ è½½æŠ˜çº¿å›¾æ•°æ®ï¼Œä¼ æ„Ÿå™¨ç±»å‹:', this.selectedSensorType)

      let result = await request.post('/statistic/lineChart', {
        startTime: '2024-08-01',
        endTime: '2024-08-31',
        sensorType: this.selectedSensorType
      }) as ApiResult

      console.info('=== APIå“åº”è¯¦ç»†ä¿¡æ¯ ===')
      console.info('APIå“åº”æˆåŠŸ:', result?.success)
      console.info('APIå“åº”æ¶ˆæ¯:', result?.message)
      console.info('APIå“åº”æ•°æ®:', result?.data)

      if (result?.success && result?.data) {
        let data: LineChartData = {
          sensorName: Array.from(result.data.sensorName || []).map(item => String(item)),
          maxData: Array.from(result.data.maxData || []).map(item => Number(item)),
          minData: Array.from(result.data.minData || []).map(item => Number(item)),
          avgData: Array.from(result.data.avgData || []).map(item => Number(item)),
          sensorType: result.data.sensorType || this.selectedSensorType,
          sensorUnit: result.data.sensorUnit || '',
          sensorTypeDesc: result.data.sensorTypeDesc || '',
          totalCount: result.data.totalCount || 0,
          validCount: result.data.validCount || 0,
          dataQuality: result.data.dataQuality || ''
        }

        console.info('=== å¤„ç†åçš„æ•°æ® ===')
        console.info('å¤„ç†åä¼ æ„Ÿå™¨æ•°é‡:', data.sensorName.length)
        console.info('æŠ˜çº¿å›¾æ•°æ®åŠ è½½æˆåŠŸ:', data)
        return data
      } else {
        console.warn('APIè¿”å›æ— æ•ˆæ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', result)
        let mockData = this.getMockLineChartDataByType(this.selectedSensorType)
        console.info('æ¨¡æ‹Ÿæ•°æ®ä¼ æ„Ÿå™¨æ•°é‡:', mockData.sensorName.length)
        return mockData
      }
    } catch (error) {
      console.error('åŠ è½½æŠ˜çº¿å›¾æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', error)
      let mockData = this.getMockLineChartDataByType(this.selectedSensorType)
      console.info('å¼‚å¸¸æ—¶æ¨¡æ‹Ÿæ•°æ®ä¼ æ„Ÿå™¨æ•°é‡:', mockData.sensorName.length)
      return mockData
    }
  }

  // æ•°æ®åˆ†å¸ƒåŠ è½½ - æ”¯æŒä¼ æ„Ÿå™¨ç±»å‹å‚æ•°
  async loadDistribution(): Promise<DistributionData> {
    try {
      console.info('å¼€å§‹åŠ è½½æ•°æ®åˆ†å¸ƒï¼Œä¼ æ„Ÿå™¨ç±»å‹:', this.distributionSensorType)

      let result = await request.post('/statistic/distribution', {
        startTime: '2024-08-01',
        endTime: '2024-08-31',
        sensorType: this.distributionSensorType
      }) as ApiResult

      console.info('=== åˆ†å¸ƒæ•°æ®APIå“åº” ===')
      console.info('APIå“åº”æˆåŠŸ:', result?.success)
      console.info('APIå“åº”æ•°æ®:', result?.data)

      if (result?.success && result?.data) {
        let data: DistributionData = {
          xData: Array.from(result.data.xData || []).map(item => String(item)),
          yData: Array.from(result.data.yData || []).map(item => Number(item)),
          sensorType: result.data.sensorType || this.distributionSensorType,
          sensorUnit: result.data.sensorUnit || '',
          sensorTypeDesc: result.data.sensorTypeDesc || '',
          totalCount: result.data.totalCount || 0,
          analysisNote: result.data.analysisNote || ''
        }

        console.info('åˆ†å¸ƒæ•°æ®åŠ è½½æˆåŠŸ:', data)
        return data
      } else {
        console.warn('åˆ†å¸ƒAPIè¿”å›æ— æ•ˆæ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', result)
        return this.getMockDistributionDataByType(this.distributionSensorType)
      }
    } catch (error) {
      console.error('åŠ è½½åˆ†å¸ƒæ•°æ®å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', error)
      return this.getMockDistributionDataByType(this.distributionSensorType)
    }
  }

  // å…¶ä»–æ•°æ®åŠ è½½æ–¹æ³•
  async loadWarningData(): Promise<WarningData> {
    try {
      let result = await request.post('/statistic/warningData', {
        year: 2024
      }) as ApiResult

      if (result?.success && result?.data) {
        let data: WarningData = {
          fabricateName: Array.from(result.data.fabricateName || []).map(item => String(item)),
          totalNum: Array.from(result.data.totalNum || []).map(item => Number(item)),
          level1Num: Array.from(result.data.level1Num || []).map(item => Number(item)),
          level2Num: Array.from(result.data.level2Num || []).map(item => Number(item)),
          level3Num: Array.from(result.data.level3Num || []).map(item => Number(item)),
          mom: result.data.mom ? Array.from(result.data.mom).map(item => Number(item)) : undefined
        }
        return data
      } else {
        return this.getMockWarningData()
      }
    } catch (error) {
      return this.getMockWarningData()
    }
  }

  async loadWarningMonth(): Promise<WarningData> {
    try {
      let result = await request.post('/statistic/warningMonth', {
        year: 2024
      }) as ApiResult

      if (result?.success && result?.data) {
        let data: WarningData = {
          fabricateName: Array.from(result.data.fabricateName || []).map(item => String(item)),
          totalNum: Array.from(result.data.totalNum || []).map(item => Number(item)),
          level1Num: Array.from(result.data.level1Num || []).map(item => Number(item)),
          level2Num: Array.from(result.data.level2Num || []).map(item => Number(item)),
          level3Num: Array.from(result.data.level3Num || []).map(item => Number(item)),
          mom: result.data.mom ? Array.from(result.data.mom).map(item => Number(item)) : undefined
        }
        return data
      } else {
        return this.getMockWarningMonthData()
      }
    } catch (error) {
      return this.getMockWarningMonthData()
    }
  }

  // =====================================
  // ä¼ æ„Ÿå™¨ç±»å‹åˆ‡æ¢å¤„ç†
  // =====================================

  // ä¼ æ„Ÿå™¨ç±»å‹æ”¹å˜å¤„ç† - æŠ˜çº¿å›¾
  async onSensorTypeChange(newType: string) {
    if (this.selectedSensorType === newType) return

    console.info('æŠ˜çº¿å›¾ä¼ æ„Ÿå™¨ç±»å‹æ”¹å˜:', this.selectedSensorType, '->', newType)
    this.selectedSensorType = newType

    // é‡æ–°åŠ è½½æŠ˜çº¿å›¾æ•°æ®
    this.loading = true
    try {
      let lineChartData = await this.loadLineChart()
      if (lineChartData && this.validateLineChartData(lineChartData)) {
        this.lineChartData = lineChartData
        // é‡æ–°ç»˜åˆ¶å›¾è¡¨
        setTimeout(() => {
          this.drawLineChart()
        }, 100)
      }
    } catch (error) {
      console.error('åˆ‡æ¢æŠ˜çº¿å›¾ä¼ æ„Ÿå™¨ç±»å‹å¤±è´¥:', error)
    } finally {
      this.loading = false
    }
  }

  // æ•°æ®åˆ†å¸ƒä¼ æ„Ÿå™¨ç±»å‹æ”¹å˜å¤„ç†
  async onDistributionSensorTypeChange(newType: string) {
    if (this.distributionSensorType === newType) return

    console.info('æ•°æ®åˆ†å¸ƒä¼ æ„Ÿå™¨ç±»å‹æ”¹å˜:', this.distributionSensorType, '->', newType)
    this.distributionSensorType = newType

    // é‡æ–°åŠ è½½åˆ†å¸ƒæ•°æ®
    this.loadingDistribution = true
    try {
      let distributionData = await this.loadDistribution()
      if (distributionData && this.validateDistributionData(distributionData)) {
        this.distributionData = distributionData
        // é‡æ–°ç»˜åˆ¶é¥¼çŠ¶å›¾
        setTimeout(() => {
          this.drawPieChart()
        }, 100)
      }
    } catch (error) {
      console.error('åˆ‡æ¢åˆ†å¸ƒä¼ æ„Ÿå™¨ç±»å‹å¤±è´¥:', error)
    } finally {
      this.loadingDistribution = false
    }
  }

  // åˆ·æ–°æ‰€æœ‰æ•°æ®
  async refreshAllData() {
    this.refreshing = true
    try {
      await this.loadSensorTypes()
      await this.loadAllData()
    } catch (error) {
      console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error)
    } finally {
      this.refreshing = false
    }
  }

  // =====================================
  // æ•°æ®éªŒè¯æ–¹æ³•
  // =====================================

  validateLineChartData(data: any): boolean {
    console.info('=== æ•°æ®éªŒè¯å¼€å§‹ ===')

    if (!data || typeof data !== 'object') {
      console.warn('æ•°æ®éªŒè¯å¤±è´¥ï¼šæ•°æ®ä¸å­˜åœ¨æˆ–ä¸æ˜¯å¯¹è±¡')
      return false
    }

    let requiredFields = ['sensorName', 'maxData', 'minData', 'avgData']
    for (let field of requiredFields) {
      if (!Array.isArray(data[field])) {
        console.warn(`æ•°æ®éªŒè¯å¤±è´¥ï¼š${field} ä¸æ˜¯æ•°ç»„`)
        return false
      }
    }

    let length = data.sensorName.length
    console.info(`æ•°æ®éªŒè¯ï¼šä¼ æ„Ÿå™¨æ•°é‡ ${length}`)

    if (data.maxData.length !== length ||
    data.minData.length !== length ||
    data.avgData.length !== length) {
      console.warn('æ•°æ®éªŒè¯å¤±è´¥ï¼šæ•°ç»„é•¿åº¦ä¸ä¸€è‡´')
      console.info(`ä¼ æ„Ÿå™¨åç§°é•¿åº¦: ${data.sensorName.length}`)
      console.info(`æœ€å¤§å€¼é•¿åº¦: ${data.maxData.length}`)
      console.info(`æœ€å°å€¼é•¿åº¦: ${data.minData.length}`)
      console.info(`å¹³å‡å€¼é•¿åº¦: ${data.avgData.length}`)
      return false
    }

    console.info('æ•°æ®éªŒè¯æˆåŠŸ')
    return true
  }

  validateDistributionData(data: any): boolean {
    return data &&
    Array.isArray(data.xData) &&
    Array.isArray(data.yData) &&
    data.xData.length === data.yData.length
  }

  validateWarningData(data: any): boolean {
    if (!data || typeof data !== 'object') return false
    let requiredFields = ['fabricateName', 'totalNum', 'level1Num', 'level2Num', 'level3Num']
    for (let field of requiredFields) {
      if (!Array.isArray(data[field])) return false
    }
    return true
  }

  // =====================================
  // æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆæ–¹æ³•
  // =====================================

  // æ ¹æ®ä¼ æ„Ÿå™¨ç±»å‹è·å–æ¨¡æ‹Ÿæ•°æ®
  getMockLineChartDataByType(sensorType: string): LineChartData {
    console.info('è·å–æ¨¡æ‹Ÿæ•°æ®ï¼Œç±»å‹:', sensorType)

    switch (sensorType) {
      case 'STRESS':
        return {
          sensorName: ['åº”åŠ›ä¼ æ„Ÿå™¨-A1', 'åº”åŠ›ä¼ æ„Ÿå™¨-A2', 'åº”åŠ›ä¼ æ„Ÿå™¨-A3', 'åº”åŠ›ä¼ æ„Ÿå™¨-A4'],
          maxData: [17500.0, 8587.0, 9876.0, 8234.0],
          minData: [6666.0, 7123.0, 8123.0, 7234.0],
          avgData: [9234.5, 7856.2, 8999.5, 7734.0],
          sensorType: 'STRESS',
          sensorUnit: 'MPa',
          sensorTypeDesc: 'åº”åŠ›ä¼ æ„Ÿå™¨',
          totalCount: 150,
          validCount: 142,
          dataQuality: 'ä¼˜ç§€'
        }
      case 'CABLE_FORCE':
        return {
          sensorName: ['ç´¢åŠ›ä¼ æ„Ÿå™¨-B1', 'ç´¢åŠ›ä¼ æ„Ÿå™¨-B2', 'ç´¢åŠ›ä¼ æ„Ÿå™¨-B3', 'ç´¢åŠ›ä¼ æ„Ÿå™¨-B4'],
          maxData: [1389.0, 1267.0, 1356.0, 1234.0],
          minData: [1156.0, 1176.0, 1198.0, 1123.0],
          avgData: [1267.5, 1215.8, 1277.0, 1178.5],
          sensorType: 'CABLE_FORCE',
          sensorUnit: 'KN',
          sensorTypeDesc: 'ç´¢åŠ›ä¼ æ„Ÿå™¨',
          totalCount: 80,
          validCount: 78,
          dataQuality: 'è‰¯å¥½'
        }
      case 'DISPLACEMENT':
        return {
          sensorName: ['ä½ç§»ä¼ æ„Ÿå™¨-C1', 'ä½ç§»ä¼ æ„Ÿå™¨-C2', 'ä½ç§»ä¼ æ„Ÿå™¨-C3', 'ä½ç§»ä¼ æ„Ÿå™¨-C4'],
          maxData: [15.67, 10.12, 14.89, 12.34],
          minData: [11.23, 7.23, 7.45, 8.12],
          avgData: [13.45, 8.67, 11.17, 10.23],
          sensorType: 'DISPLACEMENT',
          sensorUnit: 'mm',
          sensorTypeDesc: 'ä½ç§»ä¼ æ„Ÿå™¨',
          totalCount: 60,
          validCount: 57,
          dataQuality: 'è‰¯å¥½'
        }
      case 'VIBRATION':
        return {
          sensorName: ['æŒ¯åŠ¨ä¼ æ„Ÿå™¨-D1', 'æŒ¯åŠ¨ä¼ æ„Ÿå™¨-D2', 'æŒ¯åŠ¨ä¼ æ„Ÿå™¨-D3', 'æŒ¯åŠ¨ä¼ æ„Ÿå™¨-D4'],
          maxData: [0.567, 0.312, 0.445, 0.389],
          minData: [0.123, 0.123, 0.156, 0.145],
          avgData: [0.345, 0.217, 0.301, 0.267],
          sensorType: 'VIBRATION',
          sensorUnit: 'Hz',
          sensorTypeDesc: 'æŒ¯åŠ¨ä¼ æ„Ÿå™¨',
          totalCount: 45,
          validCount: 43,
          dataQuality: 'ä¸€èˆ¬'
        }
      case 'TEMPERATURE':
        return {
          sensorName: ['æ¸©åº¦ä¼ æ„Ÿå™¨-E1', 'æ¸©åº¦ä¼ æ„Ÿå™¨-E2', 'æ¸©åº¦ä¼ æ„Ÿå™¨-E3', 'æ¸©åº¦ä¼ æ„Ÿå™¨-E4'],
          maxData: [26.67, 24.12, 28.45, 25.78],
          minData: [22.23, 21.23, 24.12, 22.45],
          avgData: [24.45, 22.67, 26.28, 24.11],
          sensorType: 'TEMPERATURE',
          sensorUnit: 'â„ƒ',
          sensorTypeDesc: 'æ¸©åº¦ä¼ æ„Ÿå™¨',
          totalCount: 30,
          validCount: 30,
          dataQuality: 'ä¼˜ç§€'
        }
      case 'WIND_SPEED':
        return {
          sensorName: ['é£é€Ÿä¼ æ„Ÿå™¨-F1', 'é£é€Ÿä¼ æ„Ÿå™¨-F2'],
          maxData: [21.89, 18.45],
          minData: [12.45, 14.23],
          avgData: [17.17, 16.34],
          sensorType: 'WIND_SPEED',
          sensorUnit: 'm/s',
          sensorTypeDesc: 'é£é€Ÿä¼ æ„Ÿå™¨',
          totalCount: 20,
          validCount: 19,
          dataQuality: 'è‰¯å¥½'
        }
      case 'LOAD':
        return {
          sensorName: ['è·è½½ä¼ æ„Ÿå™¨-G1'],
          maxData: [61.89],
          minData: [45.67],
          avgData: [53.78],
          sensorType: 'LOAD',
          sensorUnit: 'T',
          sensorTypeDesc: 'è·è½½ä¼ æ„Ÿå™¨',
          totalCount: 15,
          validCount: 14,
          dataQuality: 'ä¸€èˆ¬'
        }
      default:
        return this.getMockLineChartData()
    }
  }

  // æ ¹æ®ä¼ æ„Ÿå™¨ç±»å‹è·å–æ¨¡æ‹Ÿåˆ†å¸ƒæ•°æ®
  getMockDistributionDataByType(sensorType: string): DistributionData {
    console.info('è·å–æ¨¡æ‹Ÿåˆ†å¸ƒæ•°æ®ï¼Œç±»å‹:', sensorType)

    switch (sensorType) {
      case 'STRESS':
        return {
          xData: ["0-1000", "1000-3000", "3000-5000", "5000-8000", "8000-12000", "12000-16000", "16000-20000", "20000ä»¥ä¸Š"],
          yData: [0.15, 0.25, 0.20, 0.18, 0.12, 0.08, 0.02, 0.00],
          sensorType: 'STRESS',
          sensorUnit: 'MPa',
          sensorTypeDesc: 'åº”åŠ›ä¼ æ„Ÿå™¨',
          totalCount: 150,
          analysisNote: "åº”åŠ›ä¼ æ„Ÿå™¨æ•°æ®ä¸»è¦é›†ä¸­åœ¨1000-3000MPaåŒºé—´(25.0%)ã€‚å»ºè®®å…³æ³¨é«˜åº”åŠ›åŒºé—´çš„æ•°æ®ï¼ŒåŠæ—¶è¿›è¡Œç»“æ„å®‰å…¨è¯„ä¼°ã€‚"
        }
      case 'CABLE_FORCE':
        return {
          xData: ["0-500", "500-800", "800-1100", "1100-1400", "1400-1700", "1700-2000", "2000-2500", "2500ä»¥ä¸Š"],
          yData: [0.05, 0.15, 0.30, 0.25, 0.15, 0.08, 0.02, 0.00],
          sensorType: 'CABLE_FORCE',
          sensorUnit: 'KN',
          sensorTypeDesc: 'ç´¢åŠ›ä¼ æ„Ÿå™¨',
          totalCount: 80,
          analysisNote: "ç´¢åŠ›ä¼ æ„Ÿå™¨æ•°æ®ä¸»è¦é›†ä¸­åœ¨800-1100KNåŒºé—´(30.0%)ã€‚ç´¢åŠ›åˆ†å¸ƒåº”ä¿æŒç›¸å¯¹å‡åŒ€ï¼Œå¼‚å¸¸é«˜å€¼éœ€è¦é‡ç‚¹ç›‘æµ‹ã€‚"
        }
      case 'DISPLACEMENT':
        return {
          xData: ["0-2", "2-5", "5-10", "10-15", "15-20", "20-30", "30-50", "50ä»¥ä¸Š"],
          yData: [0.20, 0.35, 0.25, 0.12, 0.05, 0.02, 0.01, 0.00],
          sensorType: 'DISPLACEMENT',
          sensorUnit: 'mm',
          sensorTypeDesc: 'ä½ç§»ä¼ æ„Ÿå™¨',
          totalCount: 60,
          analysisNote: "ä½ç§»ä¼ æ„Ÿå™¨æ•°æ®ä¸»è¦é›†ä¸­åœ¨2-5mmåŒºé—´(35.0%)ã€‚ä½ç§»æ•°æ®åº”æ§åˆ¶åœ¨è®¾è®¡èŒƒå›´å†…ï¼Œè¶…é™éœ€è¦ç«‹å³å¤„ç†ã€‚"
        }
      case 'VIBRATION':
        return {
          xData: ["0-0.1", "0.1-0.2", "0.2-0.3", "0.3-0.5", "0.5-0.8", "0.8-1.2", "1.2-2.0", "2.0ä»¥ä¸Š"],
          yData: [0.30, 0.25, 0.20, 0.15, 0.07, 0.02, 0.01, 0.00],
          sensorType: 'VIBRATION',
          sensorUnit: 'Hz',
          sensorTypeDesc: 'æŒ¯åŠ¨ä¼ æ„Ÿå™¨',
          totalCount: 45,
          analysisNote: "æŒ¯åŠ¨ä¼ æ„Ÿå™¨æ•°æ®ä¸»è¦é›†ä¸­åœ¨0-0.1HzåŒºé—´(30.0%)ã€‚æŒ¯åŠ¨é¢‘ç‡è¿‡é«˜å¯èƒ½å½±å“ç»“æ„å®‰å…¨ï¼Œå»ºè®®åŠ å¼ºç›‘æµ‹ã€‚"
        }
      case 'TEMPERATURE':
        return {
          xData: ["0ä»¥ä¸‹", "0-10", "10-20", "20-25", "25-30", "30-35", "35-40", "40ä»¥ä¸Š"],
          yData: [0.05, 0.15, 0.25, 0.30, 0.18, 0.05, 0.02, 0.00],
          sensorType: 'TEMPERATURE',
          sensorUnit: 'â„ƒ',
          sensorTypeDesc: 'æ¸©åº¦ä¼ æ„Ÿå™¨',
          totalCount: 30,
          analysisNote: "æ¸©åº¦ä¼ æ„Ÿå™¨æ•°æ®ä¸»è¦é›†ä¸­åœ¨20-25â„ƒåŒºé—´(30.0%)ã€‚æ¸©åº¦å˜åŒ–ä¼šå½±å“ç»“æ„æ€§èƒ½ï¼Œæ³¨æ„æç«¯æ¸©åº¦çš„å½±å“ã€‚"
        }
      case 'WIND_SPEED':
        return {
          xData: ["0-2", "2-5", "5-10", "10-15", "15-20", "20-25", "25-30", "30ä»¥ä¸Š"],
          yData: [0.25, 0.35, 0.25, 0.10, 0.03, 0.01, 0.01, 0.00],
          sensorType: 'WIND_SPEED',
          sensorUnit: 'm/s',
          sensorTypeDesc: 'é£é€Ÿä¼ æ„Ÿå™¨',
          totalCount: 20,
          analysisNote: "é£é€Ÿä¼ æ„Ÿå™¨æ•°æ®ä¸»è¦é›†ä¸­åœ¨2-5m/såŒºé—´(35.0%)ã€‚é«˜é£é€Ÿä¼šå½±å“ç»“æ„ç¨³å®šæ€§ï¼Œå»ºè®®åœ¨æ¶åŠ£å¤©æ°”åŠ å¼ºç›‘æµ‹ã€‚"
        }
      case 'LOAD':
        return {
          xData: ["0-10", "10-20", "20-30", "30-40", "40-50", "50-60", "60-80", "80ä»¥ä¸Š"],
          yData: [0.20, 0.30, 0.25, 0.15, 0.07, 0.02, 0.01, 0.00],
          sensorType: 'LOAD',
          sensorUnit: 'T',
          sensorTypeDesc: 'è·è½½ä¼ æ„Ÿå™¨',
          totalCount: 15,
          analysisNote: "è·è½½ä¼ æ„Ÿå™¨æ•°æ®ä¸»è¦é›†ä¸­åœ¨10-20TåŒºé—´(30.0%)ã€‚è·è½½åˆ†å¸ƒåº”ç¬¦åˆè®¾è®¡é¢„æœŸï¼Œè¿‡è½½æƒ…å†µéœ€è¦åŠæ—¶å¤„ç†ã€‚"
        }
      default:
        return this.getMockDistributionData()
    }
  }

  getMockDistributionData(): DistributionData {
    return {
      xData: ["500-1000", "1000-1500", "1500-2000", "2000-2500", "10000ä»¥ä¸Š"],
      yData: [0.3, 0.2, 0.3, 0.22, 0.33],
      sensorType: 'ALL',
      sensorUnit: '',
      sensorTypeDesc: 'å…¨éƒ¨ä¼ æ„Ÿå™¨',
      totalCount: 200,
      analysisNote: "ç»¼åˆä¼ æ„Ÿå™¨æ•°æ®ä¸»è¦é›†ä¸­åœ¨1000-1500åŒºé—´(25.0%)ã€‚å»ºè®®æ ¹æ®å®é™…å·¥å†µåˆ¶å®šç›¸åº”çš„ç›‘æµ‹ç­–ç•¥ã€‚"
    }
  }

  getMockWarningData(): WarningData {
    return {
      fabricateName: ["æ¡¥èº«/ 1#æ¡¥èº«", "æ¡¥èº«/2#æ¡¥èº«"],
      totalNum: [22, 8],
      level1Num: [6, 0],
      level2Num: [6, 2],
      level3Num: [10, 6],
      mom: undefined
    }
  }

  getMockWarningMonthData(): WarningData {
    return {
      fabricateName: ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"],
      totalNum: [0, 0, 30, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      level1Num: [0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      level2Num: [0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      level3Num: [0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      mom: [0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0]
    }
  }

  getMockLineChartData(): LineChartData {
    return {
      sensorName: [
        'åº”åŠ›ä¼ æ„Ÿå™¨-A1', 'åº”åŠ›ä¼ æ„Ÿå™¨-A2', 'ç´¢åŠ›ä¼ æ„Ÿå™¨-B1', 'ç´¢åŠ›ä¼ æ„Ÿå™¨-B2',
        'ä½ç§»ä¼ æ„Ÿå™¨-C1', 'ä½ç§»ä¼ æ„Ÿå™¨-C2', 'æŒ¯åŠ¨ä¼ æ„Ÿå™¨-D1', 'æŒ¯åŠ¨ä¼ æ„Ÿå™¨-D2',
        'æ¸©åº¦ä¼ æ„Ÿå™¨-E1', 'æ¸©åº¦ä¼ æ„Ÿå™¨-E2', 'é£é€Ÿä¼ æ„Ÿå™¨-F1', 'è·è½½ä¼ æ„Ÿå™¨-G1',
        'åº”åŠ›ä¼ æ„Ÿå™¨-A3', 'ç´¢åŠ›ä¼ æ„Ÿå™¨-B3', 'ä½ç§»ä¼ æ„Ÿå™¨-C3'
      ],
      maxData: [
        17500.0, 8587.0, 1389.0, 1267.0, 15.67, 10.12, 0.567, 0.312,
        26.67, 24.12, 21.89, 61.89, 9876.0, 1356.0, 14.89
      ],
      minData: [
        6666.0, 7123.0, 1156.0, 1176.0, 11.23, 7.23, 0.123, 0.123,
        22.23, 21.23, 12.45, 45.67, 8123.0, 1198.0, 7.45
      ],
      avgData: [
        9234.5, 7856.2, 1267.5, 1215.8, 13.45, 8.67, 0.345, 0.217,
        24.45, 22.67, 17.17, 53.78, 8999.5, 1277.0, 11.17
      ],
      sensorType: 'ALL',
      sensorUnit: '',
      sensorTypeDesc: 'å…¨éƒ¨ä¼ æ„Ÿå™¨',
      totalCount: 300,
      validCount: 285,
      dataQuality: 'è‰¯å¥½'
    }
  }

  // =====================================
  // ä¸»ç•Œé¢æ„å»º
  // =====================================

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('æ•°æ®ç»Ÿè®¡')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')

        Blank()

        Row() {
          if (this.refreshing) {
            LoadingProgress()
              .width(16)
              .height(16)
              .color('#4852C9')
              .margin({ right: 8 })
          }

          Button('åˆ·æ–°')
            .fontSize(14)
            .backgroundColor('#4852C9')
            .enabled(!this.refreshing)
            .onClick(() => {
              console.info('ç”¨æˆ·ç‚¹å‡»åˆ·æ–°æŒ‰é’®')
              this.refreshAllData()
            })
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor('#f8f9fa')

      if (this.loading || this.loadingSensorTypes) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#4852C9')

          Text('æ•°æ®åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666')
            .margin({ top: 8 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        // å›¾è¡¨é€‰æ‹©å™¨
        Row() {
          ForEach(['æŠ˜çº¿å›¾', 'æ•°æ®åˆ†å¸ƒ', 'é¢„è­¦åˆ†æ', 'æœˆåº¦é¢„è­¦'], (item: string, index: number) => {
            Text(item)
              .fontSize(14)
              .fontColor(this.currentChart === item ? '#4852C9' : '#666')
              .fontWeight(this.currentChart === item ? FontWeight.Bold : FontWeight.Normal)
              .padding({ left: 12, right: 12, top: 8, bottom: 8 })
              .backgroundColor(this.currentChart === item ? '#e8f0fe' : Color.Transparent)
              .borderRadius(16)
              .onClick(() => {
                this.currentChart = item
              })
              .margin({ right: index < 3 ? 8 : 0 })
          })
        }
        .width('100%')
        .padding(16)

        // ä¼ æ„Ÿå™¨ç±»å‹é€‰æ‹©å™¨
        if (this.currentChart === 'æŠ˜çº¿å›¾') {
          this.SensorTypeSelector()
        } else if (this.currentChart === 'æ•°æ®åˆ†å¸ƒ') {
          this.DistributionSensorTypeSelector()
        }

        // å›¾è¡¨å†…å®¹åŒºåŸŸ
        Scroll() {
          Column() {
            if (this.currentChart === 'æŠ˜çº¿å›¾') {
              this.LineChartView()
            } else if (this.currentChart === 'æ•°æ®åˆ†å¸ƒ') {
              this.DistributionView()
            } else if (this.currentChart === 'é¢„è­¦åˆ†æ') {
              this.WarningView()
            } else if (this.currentChart === 'æœˆåº¦é¢„è­¦') {
              this.MonthWarningView()
            }
          }
          .width('100%')
        }
        .layoutWeight(1)
        .scrollBar(BarState.Auto)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  // =====================================
  // ä¼ æ„Ÿå™¨ç±»å‹é€‰æ‹©å™¨ç»„ä»¶
  // =====================================

  // æŠ˜çº¿å›¾ä¼ æ„Ÿå™¨ç±»å‹é€‰æ‹©å™¨
  @Builder
  SensorTypeSelector() {
    Column() {
      Row() {
        Text('ä¼ æ„Ÿå™¨ç±»å‹')
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .margin({ right: 12 })

        Text('é€‰æ‹©è¦æŸ¥çœ‹çš„ä¼ æ„Ÿå™¨ç±»å‹')
          .fontSize(12)
          .fontColor('#666')
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
      .margin({ bottom: 12 })

      // ä¼ æ„Ÿå™¨ç±»å‹é€‰é¡¹
      Flex({ wrap: FlexWrap.Wrap, alignItems: ItemAlign.Center }) {
        ForEach(this.sensorTypes, (type: SensorTypeInfo, index: number) => {
          if (type.code === 'OTHER' && this.sensorTypeStats[type.code] === 0) {
            // å¦‚æœå…¶ä»–ç±»å‹ä¼ æ„Ÿå™¨æ•°é‡ä¸º0ï¼Œåˆ™ä¸æ˜¾ç¤º
          } else {
            Row() {
              Text(type.name)
                .fontSize(12)
                .fontColor(this.selectedSensorType === type.code ? '#fff' : '#333')
                .fontWeight(this.selectedSensorType === type.code ? FontWeight.Bold : FontWeight.Normal)

              if (this.sensorTypeStats[type.code] !== undefined) {
                Text(`(${this.sensorTypeStats[type.code]})`)
                  .fontSize(10)
                  .fontColor(this.selectedSensorType === type.code ? '#fff' : '#999')
                  .margin({ left: 4 })
              }
            }
            .padding({ left: 10, right: 10, top: 6, bottom: 6 })
            .backgroundColor(this.selectedSensorType === type.code ? '#4852C9' : '#f0f0f0')
            .borderRadius(12)
            .margin({ right: 8, bottom: 8 })
            .onClick(() => {
              this.onSensorTypeChange(type.code)
            })
            .border({
              width: this.selectedSensorType === type.code ? 0 : 1,
              color: '#e0e0e0'
            })
          }
        })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, bottom: 8 })
    .shadow({
      radius: 2,
      color: '#00000010',
      offsetX: 0,
      offsetY: 1
    })
  }

  // æ•°æ®åˆ†å¸ƒä¼ æ„Ÿå™¨ç±»å‹é€‰æ‹©å™¨
  @Builder
  DistributionSensorTypeSelector() {
    Column() {
      Row() {
        Text('æ•°æ®åˆ†å¸ƒç±»å‹')
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .margin({ right: 12 })

        Text('é€‰æ‹©è¦åˆ†æçš„ä¼ æ„Ÿå™¨ç±»å‹')
          .fontSize(12)
          .fontColor('#666')
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
      .margin({ bottom: 12 })

      // ä¼ æ„Ÿå™¨ç±»å‹é€‰é¡¹
      Flex({ wrap: FlexWrap.Wrap, alignItems: ItemAlign.Center }) {
        ForEach(this.sensorTypes, (type: SensorTypeInfo, index: number) => {
          if (type.code === 'OTHER' && this.sensorTypeStats[type.code] === 0) {
            // å¦‚æœå…¶ä»–ç±»å‹ä¼ æ„Ÿå™¨æ•°é‡ä¸º0ï¼Œåˆ™ä¸æ˜¾ç¤º
          } else {
            Row() {
              Text(type.name)
                .fontSize(12)
                .fontColor(this.distributionSensorType === type.code ? '#fff' : '#333')
                .fontWeight(this.distributionSensorType === type.code ? FontWeight.Bold : FontWeight.Normal)

              if (this.sensorTypeStats[type.code] !== undefined) {
                Text(`(${this.sensorTypeStats[type.code]})`)
                  .fontSize(10)
                  .fontColor(this.distributionSensorType === type.code ? '#fff' : '#999')
                  .margin({ left: 4 })
              }
            }
            .padding({ left: 10, right: 10, top: 6, bottom: 6 })
            .backgroundColor(this.distributionSensorType === type.code ? '#52c41a' : '#f0f0f0')
            .borderRadius(12)
            .margin({ right: 8, bottom: 8 })
            .onClick(() => {
              this.onDistributionSensorTypeChange(type.code)
            })
            .border({
              width: this.distributionSensorType === type.code ? 0 : 1,
              color: '#e0e0e0'
            })
          }
        })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, bottom: 8 })
    .shadow({
      radius: 2,
      color: '#00000010',
      offsetX: 0,
      offsetY: 1
    })
  }

  // =====================================
  // æŠ˜çº¿å›¾è§†å›¾
  // =====================================

  @Builder
  LineChartView() {
    Column() {
      // ä¼ æ„Ÿå™¨ç±»å‹ä¿¡æ¯
      if (this.lineChartData?.sensorType && this.lineChartData.sensorType !== 'ALL') {
        Row() {
          Text(`${this.getSensorTypeName(this.lineChartData.sensorType)}æ•°æ®è¶‹åŠ¿`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')

          if (this.lineChartData.sensorUnit) {
            Text(`(å•ä½: ${this.lineChartData.sensorUnit})`)
              .fontSize(12)
              .fontColor('#666')
              .margin({ left: 8 })
          }
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)
        .margin({ bottom: 16 })
      } else {
        Text('ä¼ æ„Ÿå™¨æ•°æ®è¶‹åŠ¿')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 16 })
      }

      if (this.lineChartData &&
      this.lineChartData.sensorName &&
      this.lineChartData.sensorName.length > 0) {

        Column() {
          // æ•°æ®æ¦‚è§ˆå¡ç‰‡
          Row() {
            this.DataSummaryCard('ä¼ æ„Ÿå™¨æ•°é‡', this.lineChartData.sensorName.length.toString(), '#1890ff')
            this.DataSummaryCard('æœ€é«˜å€¼', this.getMaxOfMax().toFixed(1), '#f5222d')
            this.DataSummaryCard('æœ€ä½å€¼', this.getMinValue().toFixed(1), '#52c41a')
            this.DataSummaryCard('å¹³å‡å€¼', this.getAvgValue().toFixed(1), '#faad14')
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .margin({ bottom: 20 })

          // æ•°æ®è´¨é‡æŒ‡ç¤ºå™¨
          if (this.lineChartData.dataQuality) {
            Row() {
              Text('æ•°æ®è´¨é‡:')
                .fontSize(12)
                .fontColor('#666')
                .margin({ right: 8 })

              Text(this.lineChartData.dataQuality)
                .fontSize(12)
                .fontColor(this.getDataQualityColor(this.lineChartData.dataQuality))
                .fontWeight(FontWeight.Medium)
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                .backgroundColor(this.getDataQualityBgColor(this.lineChartData.dataQuality))
                .borderRadius(4)

              if (this.lineChartData.totalCount && this.lineChartData.validCount) {
                Text(`(${this.lineChartData.validCount}/${this.lineChartData.totalCount})`)
                  .fontSize(10)
                  .fontColor('#999')
                  .margin({ left: 8 })
              }
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({ bottom: 16 })
          }

          // CanvasæŠ˜çº¿å›¾
          this.CanvasLineChart()

          // å›¾ä¾‹
          Row() {
            this.LegendItem('æœ€å¤§å€¼', '#f5222d')
            this.LegendItem('æœ€å°å€¼', '#52c41a')
            this.LegendItem('å¹³å‡å€¼', '#faad14')
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .margin({ top: 12, bottom: 20 })

          // è¯¦ç»†æ•°æ®è¡¨æ ¼
          this.DataTable()
        }
      } else {
        // æ— æ•°æ®æç¤º
        Column() {
          Text('ğŸ“Š')
            .fontSize(60)
            .opacity(0.3)

          Text(`æš‚æ— ${this.getSensorTypeName(this.selectedSensorType)}æ•°æ®`)
            .fontSize(16)
            .fontColor('#999')
            .margin({ top: 16 })

          Text('è¯·å°è¯•é€‰æ‹©å…¶ä»–ä¼ æ„Ÿå™¨ç±»å‹æˆ–é‡æ–°åŠ è½½æ•°æ®')
            .fontSize(12)
            .fontColor('#ccc')
            .margin({ top: 8 })

          Button('é‡æ–°åŠ è½½')
            .fontSize(14)
            .backgroundColor('#4852C9')
            .margin({ top: 16 })
            .onClick(async () => {
              this.loading = true
              try {
                let lineChartData = await this.loadLineChart()
                if (lineChartData && this.validateLineChartData(lineChartData)) {
                  this.lineChartData = lineChartData
                }
              } catch (error) {
                console.error('æ‰‹åŠ¨åŠ è½½å¤±è´¥:', error)
              } finally {
                this.loading = false
              }
            })
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin(16)
    .shadow({
      radius: 4,
      color: '#00000008',
      offsetX: 0,
      offsetY: 2
    })
  }

  // æ ¹æ®ä¼ æ„Ÿå™¨ç±»å‹ä»£ç è·å–ä¸­æ–‡åç§°
  getSensorTypeName(typeCode: string): string {
    let typeMap = {
      'ALL': 'å…¨éƒ¨',
      'STRESS': 'åº”åŠ›',
      'CABLE_FORCE': 'ç´¢åŠ›',
      'DISPLACEMENT': 'ä½ç§»',
      'VIBRATION': 'æŒ¯åŠ¨',
      'TEMPERATURE': 'æ¸©åº¦',
      'WIND_SPEED': 'é£é€Ÿ',
      'LOAD': 'è·è½½',
      'OTHER': 'å…¶ä»–'
    }
    return typeMap[typeCode] || 'æœªçŸ¥'
  }

  // è·å–æ•°æ®è´¨é‡é¢œè‰²
  getDataQualityColor(quality: string): string {
    switch (quality) {
      case 'ä¼˜ç§€': return '#52c41a'
      case 'è‰¯å¥½': return '#1890ff'
      case 'ä¸€èˆ¬': return '#faad14'
      case 'è¾ƒå·®': return '#f5222d'
      default: return '#999'
    }
  }

  // è·å–æ•°æ®è´¨é‡èƒŒæ™¯è‰²
  getDataQualityBgColor(quality: string): string {
    switch (quality) {
      case 'ä¼˜ç§€': return '#f6ffed'
      case 'è‰¯å¥½': return '#e6f7ff'
      case 'ä¸€èˆ¬': return '#fffbe6'
      case 'è¾ƒå·®': return '#fff1f0'
      default: return '#f5f5f5'
    }
  }

  @Builder
  CanvasLineChart() {
    Column() {
      // ä½¿ç”¨æ¡ä»¶æ¸²æŸ“ä»£æ›¿å­—ç¬¦ä¸²æ‹¼æ¥
      if (this.lineChartData?.sensorUnit) {
        Text(`ä¼ æ„Ÿå™¨æ•°æ®è¶‹åŠ¿å›¾ (${this.lineChartData.sensorUnit})`)
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .margin({ bottom: 12 })
      } else {
        Text('ä¼ æ„Ÿå™¨æ•°æ®è¶‹åŠ¿å›¾')
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .margin({ bottom: 12 })
      }

      Stack() {
        Canvas(this.context)
          .width('100%')
          .height(280)
          .backgroundColor('#fafafa')
          .onReady(() => {
            this.drawLineChart()
          })
      }
      .width('100%')
      .height(280)
      .borderRadius(8)
      .border({
        width: 1,
        color: '#e8e8e8'
      })
    }
    .width('100%')
  }

  // =====================================
  // Canvasç»˜åˆ¶æ–¹æ³•
  // =====================================

  private drawLineChart() {
    if (!this.lineChartData || !this.context) {
      console.warn('Canvasç»˜åˆ¶å¤±è´¥ï¼šæ•°æ®æˆ–ä¸Šä¸‹æ–‡ä¸å­˜åœ¨')
      return
    }

    console.info('Canvasç»˜åˆ¶å¼€å§‹ï¼Œä¼ æ„Ÿå™¨æ•°é‡:', this.lineChartData.sensorName.length)

    let canvasWidth = 350
    let canvasHeight = 280
    let padding = { left: 60, right: 40, top: 30, bottom: 60 }
    let chartWidth = canvasWidth - padding.left - padding.right
    let chartHeight = canvasHeight - padding.top - padding.bottom

    // æ¸…ç©ºç”»å¸ƒ
    this.context.clearRect(0, 0, canvasWidth, canvasHeight)

    // ç»˜åˆ¶èƒŒæ™¯
    this.context.fillStyle = '#fafafa'
    this.context.fillRect(0, 0, canvasWidth, canvasHeight)

    // è®¡ç®—æ•°æ®èŒƒå›´
    let allValues: number[] = []
    for (let i = 0; i < this.lineChartData.maxData.length; i++) {
      allValues.push(this.lineChartData.maxData[i])
    }
    for (let i = 0; i < this.lineChartData.minData.length; i++) {
      allValues.push(this.lineChartData.minData[i])
    }
    for (let i = 0; i < this.lineChartData.avgData.length; i++) {
      allValues.push(this.lineChartData.avgData[i])
    }

    let minValue = allValues[0]
    let maxValue = allValues[0]
    for (let i = 1; i < allValues.length; i++) {
      if (allValues[i] < minValue) {
        minValue = allValues[i]
      }
      if (allValues[i] > maxValue) {
        maxValue = allValues[i]
      }
    }
    let valueRange = maxValue - minValue || 1

    // ç»˜åˆ¶ç½‘æ ¼çº¿
    this.drawGrid(canvasWidth, canvasHeight, padding, chartWidth, chartHeight, minValue, maxValue, valueRange)

    // ç»˜åˆ¶åæ ‡è½´
    this.drawAxes(canvasWidth, canvasHeight, padding, chartWidth, chartHeight)

    // ç»˜åˆ¶æ ‡ç­¾
    this.drawLabels(padding, chartWidth, chartHeight, minValue, maxValue, valueRange)

    // ç»˜åˆ¶æŠ˜çº¿å’Œæ•°æ®ç‚¹
    this.drawLines(padding, chartWidth, chartHeight, minValue, valueRange)
  }

  private drawGrid(canvasWidth: number, canvasHeight: number, padding: any, chartWidth: number, chartHeight: number, minValue: number, maxValue: number, valueRange: number) {
    this.context.strokeStyle = '#e0e0e0'
    this.context.lineWidth = 0.5

    // ç»˜åˆ¶æ°´å¹³ç½‘æ ¼çº¿
    for (let i = 0; i <= 4; i++) {
      let y = padding.top + (chartHeight * i / 4)
      this.context.beginPath()
      this.context.moveTo(padding.left, y)
      this.context.lineTo(padding.left + chartWidth, y)
      this.context.stroke()
    }

    // ç»˜åˆ¶å‚ç›´ç½‘æ ¼çº¿
    if (this.lineChartData && this.lineChartData.sensorName.length > 1) {
      let sensorCount = this.lineChartData.sensorName.length
      for (let i = 0; i < sensorCount; i++) {
        let x = padding.left + (chartWidth * i / (sensorCount - 1))
        this.context.beginPath()
        this.context.moveTo(x, padding.top)
        this.context.lineTo(x, padding.top + chartHeight)
        this.context.stroke()
      }
    }
  }

  private drawAxes(canvasWidth: number, canvasHeight: number, padding: any, chartWidth: number, chartHeight: number) {
    this.context.strokeStyle = '#333'
    this.context.lineWidth = 1

    // ç»˜åˆ¶Yè½´
    this.context.beginPath()
    this.context.moveTo(padding.left, padding.top)
    this.context.lineTo(padding.left, padding.top + chartHeight)
    this.context.stroke()

    // ç»˜åˆ¶Xè½´
    this.context.beginPath()
    this.context.moveTo(padding.left, padding.top + chartHeight)
    this.context.lineTo(padding.left + chartWidth, padding.top + chartHeight)
    this.context.stroke()
  }

  private drawLabels(padding: any, chartWidth: number, chartHeight: number, minValue: number, maxValue: number, valueRange: number) {
    this.context.fillStyle = '#666'
    this.context.font = '14px sans-serif'
    this.context.textAlign = 'right'

    // Yè½´æ ‡ç­¾
    for (let i = 0; i <= 4; i++) {
      let value = maxValue - (valueRange * i / 4)
      let y = padding.top + (chartHeight * i / 4) + 5
      this.context.fillText(value.toFixed(0), padding.left - 10, y)
    }

    // Xè½´æ ‡ç­¾
    if (this.lineChartData) {
      this.context.textAlign = 'center'
      this.context.font = '10px sans-serif'

      let sensorCount = this.lineChartData.sensorName.length

      for (let i = 0; i < sensorCount; i++) {
        let x = padding.left + (chartWidth * i / (sensorCount - 1))
        let label = this.lineChartData.sensorName[i]
        let displayLabel = label.length > 8 ? label.substring(0, 8) + '..' : label

        // ä¿å­˜å½“å‰ä¸Šä¸‹æ–‡
        this.context.save()
        // ç§»åŠ¨åˆ°æ ‡ç­¾ä½ç½®
        this.context.translate(x, padding.top + chartHeight + 35)
        // å¦‚æœä¼ æ„Ÿå™¨å¾ˆå¤šï¼Œæ—‹è½¬æ ‡ç­¾
        if (sensorCount > 10) {
          this.context.rotate(-Math.PI / 4)
        }
        this.context.fillText(displayLabel, 0, 0)
        // æ¢å¤ä¸Šä¸‹æ–‡
        this.context.restore()
      }
    }
  }

  private drawLines(padding: any, chartWidth: number, chartHeight: number, minValue: number, valueRange: number) {
    if (!this.lineChartData) return

    // ç»˜åˆ¶æœ€å¤§å€¼çº¿
    this.drawSingleLine(this.lineChartData.maxData, '#f5222d', padding, chartWidth, chartHeight, minValue, valueRange)
    this.drawDataPoints(this.lineChartData.maxData, '#f5222d', padding, chartWidth, chartHeight, minValue, valueRange)

    // ç»˜åˆ¶å¹³å‡å€¼çº¿
    this.drawSingleLine(this.lineChartData.avgData, '#faad14', padding, chartWidth, chartHeight, minValue, valueRange)
    this.drawDataPoints(this.lineChartData.avgData, '#faad14', padding, chartWidth, chartHeight, minValue, valueRange)

    // ç»˜åˆ¶æœ€å°å€¼çº¿
    this.drawSingleLine(this.lineChartData.minData, '#52c41a', padding, chartWidth, chartHeight, minValue, valueRange)
    this.drawDataPoints(this.lineChartData.minData, '#52c41a', padding, chartWidth, chartHeight, minValue, valueRange)
  }

  private drawSingleLine(data: number[], color: string, padding: any, chartWidth: number, chartHeight: number, minValue: number, valueRange: number) {
    if (data.length < 2) return

    this.context.strokeStyle = color
    this.context.lineWidth = 2

    this.context.beginPath()
    for (let i = 0; i < data.length; i++) {
      let x = padding.left + (chartWidth * i / (data.length - 1))
      let y = padding.top + chartHeight - ((data[i] - minValue) / valueRange) * chartHeight

      if (i === 0) {
        this.context.moveTo(x, y)
      } else {
        this.context.lineTo(x, y)
      }
    }
    this.context.stroke()
  }

  private drawDataPoints(data: number[], color: string, padding: any, chartWidth: number, chartHeight: number, minValue: number, valueRange: number) {
    this.context.fillStyle = color
    this.context.strokeStyle = '#fff'
    this.context.lineWidth = 1

    for (let i = 0; i < data.length; i++) {
      let x = padding.left + (chartWidth * i / (data.length - 1))
      let y = padding.top + chartHeight - ((data[i] - minValue) / valueRange) * chartHeight

      this.context.beginPath()
      this.context.arc(x, y, 3, 0, 2 * Math.PI)
      this.context.fill()
      this.context.stroke()
    }
  }

  @Builder
  LegendItem(label: string, color: string) {
    Row() {
      Circle({ width: 8, height: 8 })
        .fill(color)
        .margin({ right: 4 })

      Text(label)
        .fontSize(12)
        .fontColor('#666')
    }
    .margin({ right: 16 })
  }

  // =====================================
  // è¾…åŠ©è®¡ç®—æ–¹æ³•
  // =====================================

  getSafeValue(value: any): number {
    if (typeof value === 'number' && !isNaN(value) && isFinite(value)) {
      return Math.max(0, value)
    }
    return 0
  }

  getMaxOfMax(): number {
    if (!this.lineChartData || !this.lineChartData.maxData) {
      return 0
    }
    let validValues = this.lineChartData.maxData.filter(val => typeof val === 'number' && !isNaN(val) && isFinite(val))
    if (validValues.length === 0) {
      return 0
    }

    let maxVal = validValues[0]
    for (let i = 1; i < validValues.length; i++) {
      if (validValues[i] > maxVal) {
        maxVal = validValues[i]
      }
    }
    return maxVal
  }

  getMinValue(): number {
    if (!this.lineChartData || !this.lineChartData.minData) {
      return 0
    }
    let validValues = this.lineChartData.minData.filter(val => typeof val === 'number' && !isNaN(val) && isFinite(val))
    if (validValues.length === 0) {
      return 0
    }

    let minVal = validValues[0]
    for (let i = 1; i < validValues.length; i++) {
      if (validValues[i] < minVal) {
        minVal = validValues[i]
      }
    }
    return minVal
  }

  getAvgValue(): number {
    if (!this.lineChartData || !this.lineChartData.avgData) {
      return 0
    }
    let validValues = this.lineChartData.avgData.filter(val => typeof val === 'number' && !isNaN(val) && isFinite(val))
    if (validValues.length === 0) {
      return 0
    }

    let sum = validValues.reduce((a, b) => a + b, 0)
    return sum / validValues.length
  }

  @Builder
  DataSummaryCard(title: string, value: string, color: string) {
    Column() {
      Text(value)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(10)
        .fontColor('#666')
        .margin({ top: 4 })
    }
    .padding(8)
    .backgroundColor(Color.White)
    .borderRadius(6)
    .width(75)
    .border({
      width: 1,
      color: color,
      style: BorderStyle.Solid
    })
    .shadow({
      radius: 2,
      color: '#00000008',
      offsetX: 0,
      offsetY: 1
    })
  }

  // =====================================
  // æ•°æ®è¡¨æ ¼ç»„ä»¶
  // =====================================

  @Builder
  DataTable() {
    Column() {
      // è¡¨æ ¼æ ‡é¢˜å’Œåˆ†é¡µæ§åˆ¶
      Row() {
        Text('è¯¦ç»†æ•°æ®')
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .alignSelf(ItemAlign.Start)

        Blank()

        Text(`å…± ${this.lineChartData?.sensorName?.length || 0} ä¸ªä¼ æ„Ÿå™¨`)
          .fontSize(12)
          .fontColor('#666')
          .margin({ right: 8 })

        if (this.lineChartData && this.lineChartData.sensorName.length > this.pageSize) {
          Row() {
            Button('ä¸Šä¸€é¡µ')
              .fontSize(12)
              .backgroundColor(this.currentPage > 0 ? '#4852C9' : '#d9d9d9')
              .enabled(this.currentPage > 0)
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .onClick(() => {
                if (this.currentPage > 0) {
                  this.currentPage--
                }
              })
              .margin({ right: 8 })

            Text(`${this.currentPage + 1}/${this.getTotalPages()}`)
              .fontSize(12)
              .fontColor('#666')
              .margin({ right: 8 })

            Button('ä¸‹ä¸€é¡µ')
              .fontSize(12)
              .backgroundColor(this.currentPage < this.getTotalPages() - 1 ? '#4852C9' : '#d9d9d9')
              .enabled(this.currentPage < this.getTotalPages() - 1)
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .onClick(() => {
                if (this.currentPage < this.getTotalPages() - 1) {
                  this.currentPage++
                }
              })
          }
        }
      }
      .width('100%')
      .margin({ bottom: 12 })

      // æ˜¾ç¤ºæ‰€æœ‰æ•°æ®çš„é€‰é¡¹
      Row() {
        Button(this.pageSize === 1000 ? 'åˆ†é¡µæ˜¾ç¤º' : 'æ˜¾ç¤ºå…¨éƒ¨')
          .fontSize(12)
          .backgroundColor('#52c41a')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .onClick(() => {
            if (this.pageSize === 1000) {
              this.pageSize = 10
              this.currentPage = 0
            } else {
              this.pageSize = 1000 // è®¾ç½®ä¸€ä¸ªå¾ˆå¤§çš„æ•°å­—æ¥æ˜¾ç¤ºæ‰€æœ‰æ•°æ®
              this.currentPage = 0
            }
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      .margin({ bottom: 8 })

      // è¡¨å¤´
      Row() {
        Text('ä¼ æ„Ÿå™¨')
          .fontSize(12)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .width(this.calculateColumnWidth('sensor'))
          .textAlign(TextAlign.Center)
        Text('æœ€å¤§å€¼')
          .fontSize(12)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .width(this.calculateColumnWidth('max'))
          .textAlign(TextAlign.Center)
        Text('æœ€å°å€¼')
          .fontSize(12)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .width(this.calculateColumnWidth('min'))
          .textAlign(TextAlign.Center)
        Text('å¹³å‡å€¼')
          .fontSize(12)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .width(this.calculateColumnWidth('avg'))
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .padding({ top: 12, bottom: 12, left: 8, right: 8 })
      .backgroundColor('#e6f7ff')
      .borderRadius(6)
      .border({
        width: 1,
        color: '#d9d9d9'
      })

      // æ•°æ®è¡Œ - ä½¿ç”¨åˆ†é¡µæ•°æ®
      if (this.lineChartData) {
        Text(`æ˜¾ç¤º ${this.getPagedSensorNames().length} / ${this.lineChartData.sensorName.length} ä¸ªä¼ æ„Ÿå™¨`)
          .fontSize(10)
          .fontColor('#999')
          .margin({ top: 8, bottom: 8 })

        ForEach(this.getPagedSensorNames(), (sensor: string, index: number) => {
          Row() {
            Text(sensor)
              .fontSize(12)
              .fontColor('#333')
              .width(this.calculateColumnWidth('sensor'))
              .textAlign(TextAlign.Center)
              .margin({ right: 4 })
            if (this.lineChartData) {
              Text(this.getSafeValue(this.lineChartData.maxData[this.getRealIndex(index)]).toFixed(2))
                .fontSize(12)
                .fontColor('#f5222d')
                .fontWeight(FontWeight.Medium)
                .width(this.calculateColumnWidth('max'))
                .textAlign(TextAlign.Center)
                .margin({ right: 4 })
              Text(this.getSafeValue(this.lineChartData.minData[this.getRealIndex(index)]).toFixed(2))
                .fontSize(12)
                .fontColor('#52c41a')
                .fontWeight(FontWeight.Medium)
                .width(this.calculateColumnWidth('min'))
                .textAlign(TextAlign.Center)
                .margin({ right: 4 })
              Text(this.getSafeValue(this.lineChartData.avgData[this.getRealIndex(index)]).toFixed(2))
                .fontSize(12)
                .fontColor('#faad14')
                .fontWeight(FontWeight.Medium)
                .width(this.calculateColumnWidth('avg'))
                .textAlign(TextAlign.Center)
            }
          }
          .width('100%')
          .padding({ top: 10, bottom: 10, left: 8, right: 8 })
          .backgroundColor(index % 2 === 0 ? '#fafafa' : Color.White)
          .border({
            width: { bottom: 1 },
            color: '#f0f0f0'
          })
        })
      }
    }
    .width('100%')
    .margin({ top: 16 })
    .backgroundColor(Color.White)
    .borderRadius(8)
    .border({
      width: 1,
      color: '#d9d9d9'
    })
    .shadow({
      radius: 2,
      color: '#00000008',
      offsetX: 0,
      offsetY: 1
    })
  }

  // åˆ†é¡µç›¸å…³è¾…åŠ©æ–¹æ³•
  getTotalPages(): number {
    if (!this.lineChartData || !this.lineChartData.sensorName) {
      return 1
    }
    return Math.ceil(this.lineChartData.sensorName.length / this.pageSize)
  }

  getPagedSensorNames(): string[] {
    if (!this.lineChartData || !this.lineChartData.sensorName) {
      return []
    }

    let startIndex = this.currentPage * this.pageSize
    let endIndex = Math.min(startIndex + this.pageSize, this.lineChartData.sensorName.length)
    return this.lineChartData.sensorName.slice(startIndex, endIndex)
  }

  getRealIndex(pagedIndex: number): number {
    return this.currentPage * this.pageSize + pagedIndex
  }

  calculateColumnWidth(type: string): string {
    switch (type) {
      case 'sensor': return '40%'
      case 'max': return '20%'
      case 'min': return '20%'
      case 'avg': return '20%'
      default: return '25%'
    }
  }

  // =====================================
  // æ•°æ®åˆ†å¸ƒè§†å›¾
  // =====================================

  @Builder
  DistributionView() {
    Column() {
      // æ ‡é¢˜åŒºåŸŸ
      Row() {
        Column() {
          if (this.distributionData?.sensorTypeDesc && this.distributionData.sensorTypeDesc !== 'å…¨éƒ¨ä¼ æ„Ÿå™¨') {
            Text(`${this.distributionData.sensorTypeDesc}åˆ†å¸ƒåˆ†æ`)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1a1a1a')
          } else {
            Text('æ•°å€¼åˆ†å¸ƒåˆ†æ')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1a1a1a')
          }

          if (this.distributionData?.sensorUnit) {
            Text(`${this.distributionData.sensorTypeDesc || 'ä¼ æ„Ÿå™¨'}æ•°æ®åŒºé—´åˆ†å¸ƒç»Ÿè®¡ (${this.distributionData.sensorUnit})`)
              .fontSize(12)
              .fontColor('#666')
              .margin({ top: 2 })
          } else {
            Text('ä¼ æ„Ÿå™¨æ•°æ®åŒºé—´åˆ†å¸ƒç»Ÿè®¡')
              .fontSize(12)
              .fontColor('#666')
              .margin({ top: 2 })
          }
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        Stack() {
          Circle({ width: 40, height: 40 })
            .fill('#e6f7ff')
          Text('ğŸ¥§')
            .fontSize(20)
        }
      }
      .width('100%')
      .margin({ bottom: 20 })

      if (this.loadingDistribution) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#52c41a')

          Text('æ•°æ®åˆ†æä¸­...')
            .fontSize(14)
            .fontColor('#666')
            .margin({ top: 8 })
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else if (this.distributionData && this.distributionData.xData.length > 0) {
        // æ•°æ®æ€»è§ˆå¡ç‰‡
        Row() {
          this.DistributionSummaryCard('æ•°æ®åŒºé—´', this.distributionData.xData.length.toString(), '#1890ff')
          this.DistributionSummaryCard('æ ·æœ¬æ•°é‡', (this.distributionData.totalCount || 0).toString(), '#52c41a')
          this.DistributionSummaryCard('æœ€é«˜å æ¯”', this.getMaxPercentage().toFixed(1) + '%', '#f5222d')
          this.DistributionSummaryCard('å¹³å‡å æ¯”', this.getAvgPercentage().toFixed(1) + '%', '#faad14')
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .margin({ bottom: 24 })

        // é¥¼çŠ¶å›¾å’Œå›¾ä¾‹
        Row() {
          Column() {
            Text('åŒºé—´åˆ†å¸ƒé¥¼çŠ¶å›¾')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')
              .margin({ bottom: 16 })
              .alignSelf(ItemAlign.Start)

            Stack() {
              Canvas(this.pieContext)
                .width(200)
                .height(200)
                .backgroundColor('#fafafa')
                .onReady(() => {
                  this.drawPieChart()
                })
            }
            .width(200)
            .height(200)
            .borderRadius(100)
            .border({
              width: 1,
              color: '#e8e8e8'
            })
          }
          .width('50%')
          .alignItems(HorizontalAlign.Center)

          Column() {
            Text('æ•°æ®è¯¦æƒ…')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')
              .margin({ bottom: 12 })
              .alignSelf(ItemAlign.Start)

            ForEach(this.distributionData.xData || [], (range: string, index: number) => {
              this.PieLegendItem(range, this.getSafeValue(this.distributionData!.yData[index]), index)
            })
          }
          .width('50%')
          .padding({ left: 16 })
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#fafafa')
        .borderRadius(12)
        .margin({ bottom: 16 })
        .alignItems(VerticalAlign.Top)

        // åˆ†æè¯´æ˜
        if (this.distributionData.analysisNote) {
          Column() {
            Text('åˆ†æè¯´æ˜')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')
              .margin({ bottom: 12 })
              .alignSelf(ItemAlign.Start)

            Text(this.distributionData.analysisNote)
              .fontSize(12)
              .fontColor('#666')
              .lineHeight(18)
              .width('100%')
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#f6ffed')
          .borderRadius(8)
          .border({
            width: 1,
            color: '#d9f7be'
          })
          .margin({ bottom: 16 })
        }

        this.DistributionLegend()

      } else {
        Column() {
          Stack() {
            Circle({ width: 80, height: 80 })
              .fill('#f0f0f0')
            Text('ğŸ“ˆ')
              .fontSize(40)
              .opacity(0.6)
          }
          .margin({ bottom: 16 })

          Text(`æš‚æ— ${this.getSensorTypeName(this.distributionSensorType)}åˆ†å¸ƒæ•°æ®`)
            .fontSize(16)
            .fontColor('#999')
            .margin({ bottom: 8 })

          Text('æ•°æ®åŠ è½½ä¸­æˆ–æš‚æ— ç›¸å…³ç»Ÿè®¡ä¿¡æ¯')
            .fontSize(12)
            .fontColor('#ccc')

          Button('é‡æ–°åŠ è½½')
            .fontSize(14)
            .backgroundColor('#52c41a')
            .borderRadius(20)
            .margin({ top: 16 })
            .onClick(async () => {
              this.loadingDistribution = true
              try {
                let distributionData = await this.loadDistribution()
                if (distributionData && this.validateDistributionData(distributionData)) {
                  this.distributionData = distributionData
                }
              } catch (error) {
                console.error('æ‰‹åŠ¨åŠ è½½åˆ†å¸ƒæ•°æ®å¤±è´¥:', error)
              } finally {
                this.loadingDistribution = false
              }
            })
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .margin(16)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  // =====================================
  // é¥¼çŠ¶å›¾ç»˜åˆ¶æ–¹æ³•
  // =====================================

  private drawPieChart() {
    if (!this.distributionData || !this.pieContext) {
      return
    }

    let canvasSize = 200
    let centerX = canvasSize / 2
    let centerY = canvasSize / 2
    let radius = 70

    this.pieContext.clearRect(0, 0, canvasSize, canvasSize)
    this.pieContext.fillStyle = '#fafafa'
    this.pieContext.fillRect(0, 0, canvasSize, canvasSize)

    let total = 0
    for (let i = 0; i < this.distributionData.yData.length; i++) {
      total += this.getSafeValue(this.distributionData.yData[i])
    }

    if (total === 0) {
      this.pieContext.strokeStyle = '#ddd'
      this.pieContext.lineWidth = 2
      this.pieContext.beginPath()
      this.pieContext.arc(centerX, centerY, radius, 0, 2 * Math.PI)
      this.pieContext.stroke()
      return
    }

    let currentAngle = -Math.PI / 2

    for (let i = 0; i < this.distributionData.yData.length; i++) {
      let value = this.getSafeValue(this.distributionData.yData[i])
      let percentage = value / total
      let sliceAngle = percentage * 2 * Math.PI

      this.pieContext.fillStyle = this.getDistributionColor(i)
      this.pieContext.beginPath()
      this.pieContext.moveTo(centerX, centerY)
      this.pieContext.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle)
      this.pieContext.closePath()
      this.pieContext.fill()

      this.pieContext.strokeStyle = '#fff'
      this.pieContext.lineWidth = 2
      this.pieContext.stroke()

      if (percentage > 0.05) {
        let labelAngle = currentAngle + sliceAngle / 2
        let labelX = centerX + Math.cos(labelAngle) * (radius * 0.7)
        let labelY = centerY + Math.sin(labelAngle) * (radius * 0.7)

        this.pieContext.fillStyle = '#fff'
        this.pieContext.font = 'bold 12px sans-serif'
        this.pieContext.textAlign = 'center'
        this.pieContext.textBaseline = 'middle'
        this.pieContext.fillText(`${(percentage * 100).toFixed(1)}%`, labelX, labelY)
      }

      currentAngle += sliceAngle
    }

    this.pieContext.fillStyle = '#fafafa'
    this.pieContext.beginPath()
    this.pieContext.arc(centerX, centerY, 25, 0, 2 * Math.PI)
    this.pieContext.fill()

    this.pieContext.fillStyle = '#333'
    this.pieContext.font = 'bold 14px sans-serif'
    this.pieContext.textAlign = 'center'
    this.pieContext.textBaseline = 'middle'
    this.pieContext.fillText('åˆ†å¸ƒ', centerX, centerY)
  }

  @Builder
  PieLegendItem(range: string, percentage: number, index: number) {
    Row() {
      Circle({ width: 12, height: 12 })
        .fill(this.getDistributionColor(index))
        .margin({ right: 8 })

      Column() {
        if (this.distributionData?.sensorUnit) {
          Text(`${range}${this.distributionData.sensorUnit}`)
            .fontSize(12)
            .fontColor('#333')
            .fontWeight(FontWeight.Medium)
            .width('100%')
            .textAlign(TextAlign.Start)
        } else {
          Text(range)
            .fontSize(12)
            .fontColor('#333')
            .fontWeight(FontWeight.Medium)
            .width('100%')
            .textAlign(TextAlign.Start)
        }

        Text(`${(percentage * 100).toFixed(1)}%`)
          .fontSize(11)
          .fontColor('#666')
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
    }
    .width('100%')
    .padding({ top: 4, bottom: 4, left: 8, right: 8 })
    .backgroundColor(Color.White)
    .borderRadius(6)
    .margin({ bottom: 6 })
    .border({
      width: 1,
      color: '#f0f0f0'
    })
    .shadow({
      radius: 1,
      color: '#00000005',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  DistributionSummaryCard(title: string, value: string, color: string) {
    Column() {
      Text(value)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(10)
        .fontColor('#666')
        .margin({ top: 4 })
    }
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .width(70)
    .border({
      width: 1,
      color: color,
      style: BorderStyle.Solid
    })
    .shadow({
      radius: 4,
      color: '#00000008',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  DistributionLegend() {
    Column() {
      Text('åˆ†å¸ƒè¯´æ˜')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333')
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)

      Row() {
        this.DistributionLegendItem('é«˜åˆ†å¸ƒåŒºé—´', '#ff4d4f', 'å æ¯”è¶…è¿‡25%')
        this.DistributionLegendItem('ä¸­åˆ†å¸ƒåŒºé—´', '#faad14', 'å æ¯”15%-25%')
        this.DistributionLegendItem('ä½åˆ†å¸ƒåŒºé—´', '#52c41a', 'å æ¯”ä½äº15%')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceEvenly)

      if (this.distributionData?.sensorType && this.distributionData.sensorType !== 'ALL') {
        Text(`* ${this.distributionData.sensorTypeDesc || 'ä¼ æ„Ÿå™¨'}æ•°æ®åŸºäºå½“å‰æ—¶é—´æ®µå†…çš„ä¼ æ„Ÿå™¨æ•°å€¼ç»Ÿè®¡åˆ†æ`)
          .fontSize(10)
          .fontColor('#999')
          .margin({ top: 12 })
          .textAlign(TextAlign.Center)
          .width('100%')
      } else {
        Text('* æ•°æ®åŸºäºå½“å‰æ—¶é—´æ®µå†…çš„ä¼ æ„Ÿå™¨æ•°å€¼ç»Ÿè®¡åˆ†æ')
          .fontSize(10)
          .fontColor('#999')
          .margin({ top: 12 })
          .textAlign(TextAlign.Center)
          .width('100%')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#f8fffe')
    .borderRadius(8)
    .border({
      width: 1,
      color: '#e6fffb'
    })
  }

  @Builder
  DistributionLegendItem(label: string, color: string, description: string) {
    Column() {
      Row() {
        Circle({ width: 8, height: 8 })
          .fill(color)
          .margin({ right: 6 })

        Text(label)
          .fontSize(11)
          .fontColor('#333')
          .fontWeight(FontWeight.Medium)
      }
      .margin({ bottom: 4 })

      Text(description)
        .fontSize(9)
        .fontColor('#666')
        .textAlign(TextAlign.Center)
        .width(80)
    }
    .alignItems(HorizontalAlign.Center)
  }

  // =====================================
  // é¢„è­¦åˆ†æè§†å›¾ - å®Œæ•´ç‰ˆæœ¬
  // =====================================

  @Builder
  WarningView() {
    Column() {
      // æ ‡é¢˜åŒºåŸŸ
      Row() {
        Column() {
          Text('é¢„è­¦åˆ†æç»Ÿè®¡')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1a1a1a')

          Text('å„æ„ä»¶é¢„è­¦çº§åˆ«åˆ†å¸ƒæƒ…å†µ')
            .fontSize(12)
            .fontColor('#666')
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        Stack() {
          Circle({ width: 40, height: 40 })
            .fill('#fff1f0')
          Text('âš ï¸')
            .fontSize(20)
        }
      }
      .width('100%')
      .margin({ bottom: 20 })

      if (this.warningData && this.warningData.fabricateName.length > 0) {
        // é¢„è­¦ç»Ÿè®¡æ¦‚è§ˆ
        Row() {
          this.WarningSummaryCard('æ€»é¢„è­¦æ•°', this.getTotalWarnings().toString(), '#ff4d4f')
          this.WarningSummaryCard('æ„ä»¶æ•°é‡', this.warningData.fabricateName.length.toString(), '#1890ff')
          this.WarningSummaryCard('æœ€é«˜çº§åˆ«', this.getHighestLevel().toString() + 'çº§', '#faad14')
          this.WarningSummaryCard('å¹³å‡é¢„è­¦', this.getAverageWarnings().toFixed(1), '#52c41a')
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .margin({ bottom: 24 })

        // é¢„è­¦æ¡å½¢å›¾
        Column() {
          Text('é¢„è­¦çº§åˆ«åˆ†å¸ƒå›¾')
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .margin({ bottom: 16 })
            .alignSelf(ItemAlign.Start)

          Stack() {
            Canvas(this.warningContext)
              .width('100%')
              .height(280)
              .backgroundColor('#fafafa')
              .onReady(() => {
                this.drawWarningChart()
              })
          }
          .width('100%')
          .height(280)
          .borderRadius(12)
          .border({
            width: 1,
            color: '#e8e8e8'
          })
          .margin({ bottom: 16 })

          // å›¾ä¾‹
          Row() {
            this.LegendItem('1çº§é¢„è­¦', '#52c41a')
            this.LegendItem('2çº§é¢„è­¦', '#faad14')
            this.LegendItem('3çº§é¢„è­¦', '#ff4d4f')
            this.LegendItem('æ€»è®¡', '#1890ff')
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
        }
        .width('100%')
        .padding(16)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .margin({ bottom: 16 })

        // è¯¦ç»†æ•°æ®å¡ç‰‡
        ForEach(this.warningData.fabricateName || [], (fabricate: string, index: number) => {
          this.WarningDetailCard(fabricate, index)
        })

        // é¢„è­¦åˆ†æè¯´æ˜
        this.WarningAnalysisNote()

      } else {
        // æ— æ•°æ®çŠ¶æ€
        Column() {
          Stack() {
            Circle({ width: 80, height: 80 })
              .fill('#fff1f0')
            Text('âš ï¸')
              .fontSize(40)
              .opacity(0.6)
          }
          .margin({ bottom: 16 })

          Text('æš‚æ— é¢„è­¦æ•°æ®')
            .fontSize(16)
            .fontColor('#999')
            .margin({ bottom: 8 })

          Text('å½“å‰æ—¶é—´æ®µå†…æ— é¢„è­¦è®°å½•')
            .fontSize(12)
            .fontColor('#ccc')

          Button('é‡æ–°åŠ è½½')
            .fontSize(14)
            .backgroundColor('#4852C9')
            .borderRadius(20)
            .margin({ top: 16 })
            .onClick(() => {
              this.loadAllData()
            })
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .margin(16)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  // ç»˜åˆ¶é¢„è­¦æ¡å½¢å›¾
  private drawWarningChart() {
    if (!this.warningData || !this.warningContext) {
      return
    }

    let canvasWidth = 320
    let canvasHeight = 280
    let padding = { left: 80, right: 30, top: 30, bottom: 60 }
    let chartWidth = canvasWidth - padding.left - padding.right
    let chartHeight = canvasHeight - padding.top - padding.bottom

    // æ¸…ç©ºç”»å¸ƒ
    this.warningContext.clearRect(0, 0, canvasWidth, canvasHeight)
    this.warningContext.fillStyle = '#fafafa'
    this.warningContext.fillRect(0, 0, canvasWidth, canvasHeight)

    // è®¡ç®—æœ€å¤§å€¼
    let maxValue = 0
    for (let i = 0; i < this.warningData.totalNum.length; i++) {
      let total = this.getSafeValue(this.warningData.totalNum[i])
      if (total > maxValue) {
        maxValue = total
      }
    }
    maxValue = Math.max(maxValue, 1)

    // ç»˜åˆ¶ç½‘æ ¼çº¿
    this.warningContext.strokeStyle = '#e0e0e0'
    this.warningContext.lineWidth = 0.5
    for (let i = 0; i <= 5; i++) {
      let y = padding.top + (chartHeight * i / 5)
      this.warningContext.beginPath()
      this.warningContext.moveTo(padding.left, y)
      this.warningContext.lineTo(padding.left + chartWidth, y)
      this.warningContext.stroke()
    }

    // ç»˜åˆ¶åæ ‡è½´
    this.warningContext.strokeStyle = '#333'
    this.warningContext.lineWidth = 1
    this.warningContext.beginPath()
    this.warningContext.moveTo(padding.left, padding.top)
    this.warningContext.lineTo(padding.left, padding.top + chartHeight)
    this.warningContext.lineTo(padding.left + chartWidth, padding.top + chartHeight)
    this.warningContext.stroke()

    // ç»˜åˆ¶Yè½´æ ‡ç­¾
    this.warningContext.fillStyle = '#666'
    this.warningContext.font = '12px sans-serif'
    this.warningContext.textAlign = 'right'
    for (let i = 0; i <= 5; i++) {
      let value = maxValue - (maxValue * i / 5)
      let y = padding.top + (chartHeight * i / 5) + 4
      this.warningContext.fillText(Math.round(value).toString(), padding.left - 10, y)
    }

    // ç»˜åˆ¶æ¡å½¢å›¾
    let barWidth = chartWidth / this.warningData.fabricateName.length * 0.8
    let barSpacing = chartWidth / this.warningData.fabricateName.length * 0.2

    for (let i = 0; i < this.warningData.fabricateName.length; i++) {
      let x = padding.left + (chartWidth / this.warningData.fabricateName.length) * i + barSpacing / 2

      // ç»˜åˆ¶å„çº§åˆ«é¢„è­¦æ¡
      let level1 = this.getSafeValue(this.warningData.level1Num[i])
      let level2 = this.getSafeValue(this.warningData.level2Num[i])
      let level3 = this.getSafeValue(this.warningData.level3Num[i])

      let currentY = padding.top + chartHeight

      // 3çº§é¢„è­¦ï¼ˆåº•éƒ¨ï¼Œçº¢è‰²ï¼‰
      if (level3 > 0) {
        let height = (level3 / maxValue) * chartHeight
        this.warningContext.fillStyle = '#ff4d4f'
        this.warningContext.fillRect(x, currentY - height, barWidth, height)
        currentY -= height
      }

      // 2çº§é¢„è­¦ï¼ˆä¸­é—´ï¼Œæ©™è‰²ï¼‰
      if (level2 > 0) {
        let height = (level2 / maxValue) * chartHeight
        this.warningContext.fillStyle = '#faad14'
        this.warningContext.fillRect(x, currentY - height, barWidth, height)
        currentY -= height
      }

      // 1çº§é¢„è­¦ï¼ˆé¡¶éƒ¨ï¼Œç»¿è‰²ï¼‰
      if (level1 > 0) {
        let height = (level1 / maxValue) * chartHeight
        this.warningContext.fillStyle = '#52c41a'
        this.warningContext.fillRect(x, currentY - height, barWidth, height)
      }

      // ç»˜åˆ¶æ¡å½¢å›¾è¾¹æ¡†
      this.warningContext.strokeStyle = '#fff'
      this.warningContext.lineWidth = 1
      let totalHeight = ((level1 + level2 + level3) / maxValue) * chartHeight
      this.warningContext.strokeRect(x, padding.top + chartHeight - totalHeight, barWidth, totalHeight)

      // ç»˜åˆ¶Xè½´æ ‡ç­¾
      this.warningContext.fillStyle = '#666'
      this.warningContext.font = '10px sans-serif'
      this.warningContext.textAlign = 'center'
      let label = this.warningData.fabricateName[i]
      let displayLabel = label.length > 8 ? label.substring(0, 8) + '..' : label
      this.warningContext.fillText(displayLabel, x + barWidth / 2, padding.top + chartHeight + 20)

      // ç»˜åˆ¶æ•°å€¼æ ‡ç­¾
      let total = level1 + level2 + level3
      if (total > 0) {
        this.warningContext.fillStyle = '#333'
        this.warningContext.font = 'bold 11px sans-serif'
        this.warningContext.fillText(total.toString(), x + barWidth / 2, padding.top + chartHeight - totalHeight - 5)
      }
    }
  }

  @Builder
  WarningDetailCard(fabricate: string, index: number) {
    Column() {
      // æ„ä»¶åç§°å’Œæ€»è®¡
      Row() {
        Column() {
          Text(fabricate)
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .margin({ bottom: 4 })
            .width('100%')
            .textAlign(TextAlign.Start)

          Text(`æ€»é¢„è­¦: ${this.getSafeValue(this.warningData!.totalNum[index])}æ¬¡`)
            .fontSize(12)
            .fontColor('#666')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        // é£é™©ç­‰çº§æŒ‡ç¤ºå™¨
        Column() {
          Text(this.getWarningLevel(index))
            .fontSize(12)
            .fontColor('#fff')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor(this.getWarningLevelColor(index))
            .borderRadius(10)
            .textAlign(TextAlign.Center)

          Text('é£é™©ç­‰çº§')
            .fontSize(10)
            .fontColor('#999')
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
      .margin({ bottom: 12 })

      // é¢„è­¦çº§åˆ«è¯¦æƒ…
      Row() {
        this.WarningLevelCard('1çº§', this.getSafeValue(this.warningData!.level1Num[index]), '#52c41a', 'æ­£å¸¸')
        this.WarningLevelCard('2çº§', this.getSafeValue(this.warningData!.level2Num[index]), '#faad14', 'æ³¨æ„')
        this.WarningLevelCard('3çº§', this.getSafeValue(this.warningData!.level3Num[index]), '#ff4d4f', 'ä¸¥é‡')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)

      // é¢„è­¦å æ¯”è¿›åº¦æ¡
      Column() {
        Text('é¢„è­¦åˆ†å¸ƒ')
          .fontSize(12)
          .fontColor('#666')
          .margin({ bottom: 8 })
          .alignSelf(ItemAlign.Start)

        this.WarningProgressBar(index)
      }
      .width('100%')
      .margin({ top: 12 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#fafafa')
    .borderRadius(12)
    .margin({ bottom: 12 })
    .border({
      width: 1,
      color: '#f0f0f0'
    })
    .shadow({
      radius: 2,
      color: '#00000008',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  WarningProgressBar(index: number) {
    if (!this.warningData) {
      Row() {
        Text('æš‚æ— é¢„è­¦æ•°æ®')
          .fontSize(10)
          .fontColor('#999')
      }
      .width('100%')
      .height(20)
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#f5f5f5')
      .borderRadius(10)
    } else {
      Column() {
        if (this.getWarningTotal(index) === 0) {
          Row() {
            Text('æš‚æ— é¢„è­¦æ•°æ®')
              .fontSize(10)
              .fontColor('#999')
          }
          .width('100%')
          .height(20)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#f5f5f5')
          .borderRadius(10)
        } else {
          Row() {
            // 1çº§é¢„è­¦
            if (this.getLevel1Percent(index) > 0) {
              Row()
                .width(`${this.getLevel1Percent(index)}%`)
                .height(8)
                .backgroundColor('#52c41a')
            }

            // 2çº§é¢„è­¦
            if (this.getLevel2Percent(index) > 0) {
              Row()
                .width(`${this.getLevel2Percent(index)}%`)
                .height(8)
                .backgroundColor('#faad14')
            }

            // 3çº§é¢„è­¦
            if (this.getLevel3Percent(index) > 0) {
              Row()
                .width(`${this.getLevel3Percent(index)}%`)
                .height(8)
                .backgroundColor('#ff4d4f')
            }
          }
          .width('100%')
          .height(8)
          .borderRadius(4)
          .backgroundColor('#f0f0f0')

          // ç™¾åˆ†æ¯”æ ‡ç­¾
          Row() {
            if (this.getLevel1Percent(index) > 0) {
              Text(`1çº§: ${this.getLevel1Percent(index).toFixed(1)}%`)
                .fontSize(9)
                .fontColor('#52c41a')
            }
            if (this.getLevel2Percent(index) > 0) {
              Text(`2çº§: ${this.getLevel2Percent(index).toFixed(1)}%`)
                .fontSize(9)
                .fontColor('#faad14')
                .margin({ left: 8 })
            }
            if (this.getLevel3Percent(index) > 0) {
              Text(`3çº§: ${this.getLevel3Percent(index).toFixed(1)}%`)
                .fontSize(9)
                .fontColor('#ff4d4f')
                .margin({ left: 8 })
            }
          }
          .width('100%')
          .margin({ top: 4 })
        }
      }
    }
  }

  @Builder
  WarningSummaryCard(title: string, value: string, color: string) {
    Column() {
      Text(value)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(10)
        .fontColor('#666')
        .margin({ top: 4 })
    }
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .width(70)
    .border({
      width: 1,
      color: color,
      style: BorderStyle.Solid
    })
    .shadow({
      radius: 4,
      color: '#00000008',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  WarningLevelCard(title: string, count: number, color: string, description: string) {
    Column() {
      Text(Math.round(count).toString())
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(11)
        .fontColor('#333')
        .margin({ top: 2 })

      Text(description)
        .fontSize(9)
        .fontColor('#999')
        .margin({ top: 1 })
    }
    .padding(8)
    .backgroundColor(Color.White)
    .borderRadius(6)
    .width(70)
    .border({
      width: 1,
      color: color,
      style: BorderStyle.Solid
    })
  }

  @Builder
  WarningAnalysisNote() {
    Column() {
      Text('é¢„è­¦åˆ†æè¯´æ˜')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333')
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)

      Row() {
        this.AnalysisNoteItem('ğŸŸ¢', '1çº§é¢„è­¦', 'è®¾å¤‡çŠ¶æ€æ­£å¸¸ï¼Œå®šæœŸç›‘æµ‹')
        this.AnalysisNoteItem('ğŸŸ¡', '2çº§é¢„è­¦', 'éœ€è¦å…³æ³¨ï¼ŒåŠ å¼ºç›‘æµ‹é¢‘ç‡')
        this.AnalysisNoteItem('ğŸ”´', '3çº§é¢„è­¦', 'ç´§æ€¥æƒ…å†µï¼Œç«‹å³å¤„ç†')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceEvenly)

      Text('* é¢„è­¦çº§åˆ«åŸºäºä¼ æ„Ÿå™¨æ•°æ®å¼‚å¸¸ç¨‹åº¦è‡ªåŠ¨åˆ¤å®šï¼Œå»ºè®®åŠæ—¶å…³æ³¨é«˜çº§åˆ«é¢„è­¦')
        .fontSize(10)
        .fontColor('#999')
        .margin({ top: 12 })
        .textAlign(TextAlign.Center)
        .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#f6ffed')
    .borderRadius(8)
    .border({
      width: 1,
      color: '#d9f7be'
    })
    .margin({ top: 16 })
  }

  @Builder
  AnalysisNoteItem(icon: string, title: string, description: string) {
    Column() {
      Text(icon)
        .fontSize(16)
        .margin({ bottom: 4 })

      Text(title)
        .fontSize(11)
        .fontColor('#333')
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 2 })

      Text(description)
        .fontSize(9)
        .fontColor('#666')
        .textAlign(TextAlign.Center)
        .width(80)
    }
    .alignItems(HorizontalAlign.Center)
  }

  // =====================================
  // æœˆåº¦é¢„è­¦è§†å›¾ - å®Œæ•´ç‰ˆæœ¬
  // =====================================

  @Builder
  MonthWarningView() {
    Column() {
      // æ ‡é¢˜åŒºåŸŸ
      Row() {
        Column() {
          Text('æœˆåº¦é¢„è­¦è¶‹åŠ¿')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1a1a1a')

          Text('å…¨å¹´é¢„è­¦æ•°æ®å˜åŒ–è¶‹åŠ¿åˆ†æ')
            .fontSize(12)
            .fontColor('#666')
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        Stack() {
          Circle({ width: 40, height: 40 })
            .fill('#e6f7ff')
          Text('ğŸ“ˆ')
            .fontSize(20)
        }
      }
      .width('100%')
      .margin({ bottom: 20 })

      if (this.warningMonthData && this.warningMonthData.fabricateName.length > 0) {
        // æœˆåº¦ç»Ÿè®¡æ¦‚è§ˆ
        Row() {
          this.MonthSummaryCard('å¹´åº¦æ€»è®¡', this.getYearTotalWarnings().toString(), '#1890ff')
          this.MonthSummaryCard('å³°å€¼æœˆä»½', this.getPeakMonth(), '#ff4d4f')
          this.MonthSummaryCard('æ´»è·ƒæœˆæ•°', this.getActiveMonths().toString(), '#52c41a')
          this.MonthSummaryCard('æœˆå‡é¢„è­¦', this.getMonthAverage().toFixed(1), '#faad14')
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .margin({ bottom: 24 })

        // æœˆåº¦è¶‹åŠ¿å›¾
        Column() {
          Text('æœˆåº¦é¢„è­¦è¶‹åŠ¿å›¾')
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .margin({ bottom: 16 })
            .alignSelf(ItemAlign.Start)

          Stack() {
            Canvas(this.monthContext)
              .width('100%')
              .height(300)
              .backgroundColor('#fafafa')
              .onReady(() => {
                this.drawMonthTrendChart()
              })
          }
          .width('100%')
          .height(300)
          .borderRadius(12)
          .border({
            width: 1,
            color: '#e8e8e8'
          })
          .margin({ bottom: 16 })

          // å›¾ä¾‹
          Row() {
            this.LegendItem('æ€»é¢„è­¦', '#1890ff')
            this.LegendItem('1çº§é¢„è­¦', '#52c41a')
            this.LegendItem('2çº§é¢„è­¦', '#faad14')
            this.LegendItem('3çº§é¢„è­¦', '#ff4d4f')
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
        }
        .width('100%')
        .padding(16)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .margin({ bottom: 16 })

        // æœˆåº¦è¯¦ç»†æ•°æ®
        this.MonthDetailList()

        // è¶‹åŠ¿åˆ†æè¯´æ˜
        this.MonthTrendAnalysis()

      } else {
        // æ— æ•°æ®çŠ¶æ€
        Column() {
          Stack() {
            Circle({ width: 80, height: 80 })
              .fill('#e6f7ff')
            Text('ğŸ“ˆ')
              .fontSize(40)
              .opacity(0.6)
          }
          .margin({ bottom: 16 })

          Text('æš‚æ— æœˆåº¦æ•°æ®')
            .fontSize(16)
            .fontColor('#999')
            .margin({ bottom: 8 })

          Text('æœ¬å¹´åº¦æš‚æ— é¢„è­¦è®°å½•')
            .fontSize(12)
            .fontColor('#ccc')

          Button('é‡æ–°åŠ è½½')
            .fontSize(14)
            .backgroundColor('#4852C9')
            .borderRadius(20)
            .margin({ top: 16 })
            .onClick(() => {
              this.loadAllData()
            })
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .margin(16)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  // ç»˜åˆ¶æœˆåº¦è¶‹åŠ¿å›¾
  private drawMonthTrendChart() {
    if (!this.warningMonthData || !this.monthContext) {
      return
    }

    let canvasWidth = 320
    let canvasHeight = 300
    let padding = { left: 50, right: 30, top: 30, bottom: 50 }
    let chartWidth = canvasWidth - padding.left - padding.right
    let chartHeight = canvasHeight - padding.top - padding.bottom

    // æ¸…ç©ºç”»å¸ƒ
    this.monthContext.clearRect(0, 0, canvasWidth, canvasHeight)
    this.monthContext.fillStyle = '#fafafa'
    this.monthContext.fillRect(0, 0, canvasWidth, canvasHeight)

    // è®¡ç®—æœ€å¤§å€¼
    let maxValue = 0
    for (let i = 0; i < this.warningMonthData.totalNum.length; i++) {
      let total = this.getSafeValue(this.warningMonthData.totalNum[i])
      if (total > maxValue) {
        maxValue = total
      }
    }
    maxValue = Math.max(maxValue, 1)

    // ç»˜åˆ¶ç½‘æ ¼çº¿
    this.monthContext.strokeStyle = '#e0e0e0'
    this.monthContext.lineWidth = 0.5
    for (let i = 0; i <= 5; i++) {
      let y = padding.top + (chartHeight * i / 5)
      this.monthContext.beginPath()
      this.monthContext.moveTo(padding.left, y)
      this.monthContext.lineTo(padding.left + chartWidth, y)
      this.monthContext.stroke()
    }

    // ç»˜åˆ¶åæ ‡è½´
    this.monthContext.strokeStyle = '#333'
    this.monthContext.lineWidth = 1
    this.monthContext.beginPath()
    this.monthContext.moveTo(padding.left, padding.top)
    this.monthContext.lineTo(padding.left, padding.top + chartHeight)
    this.monthContext.lineTo(padding.left + chartWidth, padding.top + chartHeight)
    this.monthContext.stroke()

    // ç»˜åˆ¶Yè½´æ ‡ç­¾
    this.monthContext.fillStyle = '#666'
    this.monthContext.font = '12px sans-serif'
    this.monthContext.textAlign = 'right'
    for (let i = 0; i <= 5; i++) {
      let value = maxValue - (maxValue * i / 5)
      let y = padding.top + (chartHeight * i / 5) + 4
      this.monthContext.fillText(Math.round(value).toString(), padding.left - 10, y)
    }

    // ç»˜åˆ¶æœˆåº¦æŠ˜çº¿å›¾
    this.drawMonthLines(padding, chartWidth, chartHeight, maxValue)

    // ç»˜åˆ¶Xè½´æœˆä»½æ ‡ç­¾
    this.monthContext.fillStyle = '#666'
    this.monthContext.font = '10px sans-serif'
    this.monthContext.textAlign = 'center'
    for (let i = 0; i < this.warningMonthData.fabricateName.length; i++) {
      let x = padding.left + (chartWidth * i / (this.warningMonthData.fabricateName.length - 1))
      let month = this.warningMonthData.fabricateName[i]
      this.monthContext.fillText(month, x, padding.top + chartHeight + 20)
    }
  }

  private drawMonthLines(padding: any, chartWidth: number, chartHeight: number, maxValue: number) {
    if (!this.warningMonthData) return

    // ç»˜åˆ¶æ€»é¢„è­¦è¶‹åŠ¿çº¿
    this.drawMonthLine(this.warningMonthData.totalNum, '#1890ff', padding, chartWidth, chartHeight, maxValue, 3)

    // ç»˜åˆ¶å„çº§åˆ«é¢„è­¦è¶‹åŠ¿çº¿
    this.drawMonthLine(this.warningMonthData.level1Num, '#52c41a', padding, chartWidth, chartHeight, maxValue, 2)
    this.drawMonthLine(this.warningMonthData.level2Num, '#faad14', padding, chartWidth, chartHeight, maxValue, 2)
    this.drawMonthLine(this.warningMonthData.level3Num, '#ff4d4f', padding, chartWidth, chartHeight, maxValue, 2)

    // ç»˜åˆ¶æ•°æ®ç‚¹
    this.drawMonthPoints(this.warningMonthData.totalNum, '#1890ff', padding, chartWidth, chartHeight, maxValue, 4)
    this.drawMonthPoints(this.warningMonthData.level1Num, '#52c41a', padding, chartWidth, chartHeight, maxValue, 3)
    this.drawMonthPoints(this.warningMonthData.level2Num, '#faad14', padding, chartWidth, chartHeight, maxValue, 3)
    this.drawMonthPoints(this.warningMonthData.level3Num, '#ff4d4f', padding, chartWidth, chartHeight, maxValue, 3)
  }

  private drawMonthLine(data: number[], color: string, padding: any, chartWidth: number, chartHeight: number, maxValue: number, lineWidth: number) {
    if (data.length < 2) return

    this.monthContext.strokeStyle = color
    this.monthContext.lineWidth = lineWidth

    this.monthContext.beginPath()
    for (let i = 0; i < data.length; i++) {
      let x = padding.left + (chartWidth * i / (data.length - 1))
      let y = padding.top + chartHeight - ((this.getSafeValue(data[i]) / maxValue) * chartHeight)

      if (i === 0) {
        this.monthContext.moveTo(x, y)
      } else {
        this.monthContext.lineTo(x, y)
      }
    }
    this.monthContext.stroke()
  }

  private drawMonthPoints(data: number[], color: string, padding: any, chartWidth: number, chartHeight: number, maxValue: number, radius: number) {
    this.monthContext.fillStyle = color
    this.monthContext.strokeStyle = '#fff'
    this.monthContext.lineWidth = 1

    for (let i = 0; i < data.length; i++) {
      let value = this.getSafeValue(data[i])
      if (value > 0) { // åªç»˜åˆ¶æœ‰æ•°æ®çš„ç‚¹
        let x = padding.left + (chartWidth * i / (data.length - 1))
        let y = padding.top + chartHeight - ((value / maxValue) * chartHeight)

        this.monthContext.beginPath()
        this.monthContext.arc(x, y, radius, 0, 2 * Math.PI)
        this.monthContext.fill()
        this.monthContext.stroke()

        // æ˜¾ç¤ºæ•°å€¼æ ‡ç­¾
        if (value > 0) {
          this.monthContext.fillStyle = color
          this.monthContext.font = 'bold 10px sans-serif'
          this.monthContext.textAlign = 'center'
          this.monthContext.fillText(value.toString(), x, y - 8)
        }
      }
    }
  }

  @Builder
  MonthDetailList() {
    Column() {
      Text('æœˆåº¦è¯¦ç»†æ•°æ®')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333')
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)

      ForEach(this.warningMonthData?.fabricateName || [], (month: string, index: number) => {
        this.MonthDetailItem(month, index)
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#fafafa')
    .borderRadius(12)
    .margin({ bottom: 16 })
  }

  @Builder
  MonthDetailItem(month: string, index: number) {
    if (this.warningMonthData) {
      Row() {
        // æœˆä»½
        Text(month)
          .fontSize(14)
          .fontColor(this.getMonthHasData(index) ? '#333' : '#999')
          .fontWeight(this.getMonthHasData(index) ? FontWeight.Medium : FontWeight.Normal)
          .width(60)

        // é¢„è­¦æ•°æ®
        Row() {
          this.MonthWarningCard('æ€»è®¡', this.getMonthTotal(index), this.getMonthHasData(index) ? '#1890ff' : '#d9d9d9')
          this.MonthWarningCard('1çº§', this.getMonthLevel1(index), this.getMonthHasData(index) ? '#52c41a' : '#d9d9d9')
          this.MonthWarningCard('2çº§', this.getMonthLevel2(index), this.getMonthHasData(index) ? '#faad14' : '#d9d9d9')
          this.MonthWarningCard('3çº§', this.getMonthLevel3(index), this.getMonthHasData(index) ? '#ff4d4f' : '#d9d9d9')
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.SpaceBetween)

        // ç¯æ¯”å˜åŒ–
        if (this.warningMonthData.mom && this.warningMonthData.mom[index] !== null && this.warningMonthData.mom[index] !== undefined) {
          Text(`${this.getMonthMomValue(index) > 0 ? '+' : ''}${(this.getMonthMomValue(index) * 100).toFixed(1)}%`)
            .fontSize(11)
            .fontColor(this.getMonthMomValue(index) > 0 ? '#ff4d4f' : this.getMonthMomValue(index) < 0 ? '#52c41a' : '#999')
            .fontWeight(FontWeight.Medium)
            .backgroundColor(this.getMonthMomValue(index) > 0 ? '#fff1f0' : this.getMonthMomValue(index) < 0 ? '#f6ffed' : '#f5f5f5')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(8)
            .width(60)
            .textAlign(TextAlign.Center)
        } else {
          Text('--')
            .fontSize(11)
            .fontColor('#ccc')
            .width(60)
            .textAlign(TextAlign.Center)
        }
      }
      .width('100%')
      .padding({ top: 8, bottom: 8, left: 12, right: 12 })
      .backgroundColor(this.getMonthHasData(index) ? Color.White : '#f8f8f8')
      .borderRadius(8)
      .margin({ bottom: 6 })
      .border({
        width: this.getMonthHasData(index) ? 1 : 0,
        color: this.getMonthHasData(index) ? '#e8e8e8' : Color.Transparent
      })
      .shadow({
        radius: this.getMonthHasData(index) ? 1 : 0,
        color: '#00000005',
        offsetX: 0,
        offsetY: 1
      })
      .alignItems(VerticalAlign.Center)
    }
  }

  @Builder
  MonthSummaryCard(title: string, value: string, color: string) {
    Column() {
      Text(value)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(10)
        .fontColor('#666')
        .margin({ top: 4 })
    }
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .width(70)
    .border({
      width: 1,
      color: color,
      style: BorderStyle.Solid
    })
    .shadow({
      radius: 4,
      color: '#00000008',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  MonthWarningCard(title: string, count: number, color: string) {
    Column() {
      Text(Math.round(count).toString())
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(10)
        .fontColor('#666')
    }
    .padding(4)
    .backgroundColor(Color.White)
    .borderRadius(4)
    .width(45)
  }

  @Builder
  MonthTrendAnalysis() {
    Column() {
      Text('è¶‹åŠ¿åˆ†æ')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333')
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)

      // åˆ†æå¡ç‰‡
      Column() {
        Row() {
          Column() {
            Text('ğŸ“Š')
              .fontSize(20)
              .margin({ bottom: 4 })
            Text('æ•°æ®æ´å¯Ÿ')
              .fontSize(11)
              .fontColor('#666')
          }
          .width(60)
          .alignItems(HorizontalAlign.Center)

          Column() {
            Text(this.getTrendInsight())
              .fontSize(12)
              .fontColor('#333')
              .lineHeight(18)
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .alignItems(VerticalAlign.Top)

        Divider()
          .color('#f0f0f0')
          .margin({ top: 12, bottom: 12 })

        Row() {
          Column() {
            Text('ğŸ’¡')
              .fontSize(20)
              .margin({ bottom: 4 })
            Text('å»ºè®®æªæ–½')
              .fontSize(11)
              .fontColor('#666')
          }
          .width(60)
          .alignItems(HorizontalAlign.Center)

          Column() {
            Text(this.getRecommendation())
              .fontSize(12)
              .fontColor('#333')
              .lineHeight(18)
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .alignItems(VerticalAlign.Top)
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#f0f9ff')
      .borderRadius(8)
      .border({
        width: 1,
        color: '#bae7ff'
      })
    }
    .width('100%')
    .margin({ top: 16 })
  }

  // =====================================
  // å·¥å…·æ–¹æ³• - æ•°æ®åˆ†å¸ƒç›¸å…³
  // =====================================

  private getDistributionColor(index: number): string {
    let colors = ['#1890ff', '#52c41a', '#faad14', '#f5222d', '#722ed1', '#13c2c2', '#eb2f96', '#fa8c16']
    return colors[index % colors.length]
  }

  private getMaxPercentage(): number {
    if (!this.distributionData || !this.distributionData.yData.length) {
      return 0
    }
    let validValues = this.distributionData.yData.filter(val => typeof val === 'number' && !isNaN(val))
    if (validValues.length === 0) return 0

    let maxVal = validValues[0]
    for (let i = 1; i < validValues.length; i++) {
      if (validValues[i] > maxVal) {
        maxVal = validValues[i]
      }
    }
    return maxVal * 100
  }

  private getMinPercentage(): number {
    if (!this.distributionData || !this.distributionData.yData.length) {
      return 0
    }
    let validValues = this.distributionData.yData.filter(val => typeof val === 'number' && !isNaN(val))
    if (validValues.length === 0) return 0

    let minVal = validValues[0]
    for (let i = 1; i < validValues.length; i++) {
      if (validValues[i] < minVal) {
        minVal = validValues[i]
      }
    }
    return minVal * 100
  }

  private getAvgPercentage(): number {
    if (!this.distributionData || !this.distributionData.yData.length) {
      return 0
    }
    let validValues = this.distributionData.yData.filter(val => typeof val === 'number' && !isNaN(val))
    if (validValues.length === 0) return 0

    let sum = validValues.reduce((a, b) => a + b, 0)
    return (sum / validValues.length) * 100
  }

  // =====================================
  // é¢„è­¦ç›¸å…³å·¥å…·æ–¹æ³•
  // =====================================

  private getTotalWarnings(): number {
    if (!this.warningData) return 0
    return this.warningData.totalNum.reduce((sum, val) => sum + this.getSafeValue(val), 0)
  }

  private getHighestLevel(): number {
    if (!this.warningData) return 1
    let hasLevel3 = this.warningData.level3Num.some(val => this.getSafeValue(val) > 0)
    let hasLevel2 = this.warningData.level2Num.some(val => this.getSafeValue(val) > 0)
    return hasLevel3 ? 3 : hasLevel2 ? 2 : 1
  }

  private getAverageWarnings(): number {
    if (!this.warningData || this.warningData.fabricateName.length === 0) return 0
    return this.getTotalWarnings() / this.warningData.fabricateName.length
  }

  private getWarningTotal(index: number): number {
    if (!this.warningData) return 0
    return this.getSafeValue(this.warningData.totalNum[index])
  }

  private getLevel1Percent(index: number): number {
    if (!this.warningData) return 0
    let total = this.getWarningTotal(index)
    if (total === 0) return 0
    return (this.getSafeValue(this.warningData.level1Num[index]) / total) * 100
  }

  private getLevel2Percent(index: number): number {
    if (!this.warningData) return 0
    let total = this.getWarningTotal(index)
    if (total === 0) return 0
    return (this.getSafeValue(this.warningData.level2Num[index]) / total) * 100
  }

  private getLevel3Percent(index: number): number {
    if (!this.warningData) return 0
    let total = this.getWarningTotal(index)
    if (total === 0) return 0
    return (this.getSafeValue(this.warningData.level3Num[index]) / total) * 100
  }

  private getWarningLevel(index: number): string {
    if (!this.warningData) return 'æ­£å¸¸'
    let level3 = this.getSafeValue(this.warningData.level3Num[index])
    let level2 = this.getSafeValue(this.warningData.level2Num[index])
    let level1 = this.getSafeValue(this.warningData.level1Num[index])

    if (level3 > 0) return 'é«˜é£é™©'
    if (level2 > 0) return 'ä¸­é£é™©'
    if (level1 > 0) return 'ä½é£é™©'
    return 'æ­£å¸¸'
  }

  private getWarningLevelColor(index: number): string {
    if (!this.warningData) return '#52c41a'
    let level3 = this.getSafeValue(this.warningData.level3Num[index])
    let level2 = this.getSafeValue(this.warningData.level2Num[index])
    let level1 = this.getSafeValue(this.warningData.level1Num[index])

    if (level3 > 0) return '#ff4d4f'
    if (level2 > 0) return '#faad14'
    if (level1 > 0) return '#52c41a'
    return '#d9d9d9'
  }

  // =====================================
  // æœˆåº¦é¢„è­¦ç›¸å…³å·¥å…·æ–¹æ³•
  // =====================================

  private getYearTotalWarnings(): number {
    if (!this.warningMonthData) return 0
    return this.warningMonthData.totalNum.reduce((sum, val) => sum + this.getSafeValue(val), 0)
  }

  private getPeakMonth(): string {
    if (!this.warningMonthData || this.warningMonthData.totalNum.length === 0) return '--'
    let maxValue = 0
    let maxIndex = 0

    for (let i = 0; i < this.warningMonthData.totalNum.length; i++) {
      let value = this.getSafeValue(this.warningMonthData.totalNum[i])
      if (value > maxValue) {
        maxValue = value
        maxIndex = i
      }
    }

    return maxValue > 0 ? this.warningMonthData.fabricateName[maxIndex] : '--'
  }

  private getActiveMonths(): number {
    if (!this.warningMonthData) return 0
    return this.warningMonthData.totalNum.filter(val => this.getSafeValue(val) > 0).length
  }

  private getMonthAverage(): number {
    if (!this.warningMonthData || this.warningMonthData.fabricateName.length === 0) return 0
    let activeMonths = this.getActiveMonths()
    return activeMonths > 0 ? this.getYearTotalWarnings() / activeMonths : 0
  }

  private getMonthHasData(index: number): boolean {
    if (!this.warningMonthData) return false
    return this.getSafeValue(this.warningMonthData.totalNum[index]) > 0
  }

  private getMonthTotal(index: number): number {
    if (!this.warningMonthData) return 0
    return this.getSafeValue(this.warningMonthData.totalNum[index])
  }

  private getMonthLevel1(index: number): number {
    if (!this.warningMonthData) return 0
    return this.getSafeValue(this.warningMonthData.level1Num[index])
  }

  private getMonthLevel2(index: number): number {
    if (!this.warningMonthData) return 0
    return this.getSafeValue(this.warningMonthData.level2Num[index])
  }

  private getMonthLevel3(index: number): number {
    if (!this.warningMonthData) return 0
    return this.getSafeValue(this.warningMonthData.level3Num[index])
  }

  private getMonthMomValue(index: number): number {
    if (!this.warningMonthData || !this.warningMonthData.mom) return 0
    return this.warningMonthData.mom[index] || 0
  }

  private getTrendInsight(): string {
    if (!this.warningMonthData) return 'æš‚æ— è¶³å¤Ÿæ•°æ®è¿›è¡Œåˆ†æ'

    let totalWarnings = this.getYearTotalWarnings()
    let activeMonths = this.getActiveMonths()
    let peakMonth = this.getPeakMonth()

    if (totalWarnings === 0) {
      return 'æœ¬å¹´åº¦è¿è¡ŒçŠ¶æ€è‰¯å¥½ï¼Œæœªå‡ºç°é¢„è­¦äº‹ä»¶ã€‚å»ºè®®ç»§ç»­ä¿æŒå®šæœŸç›‘æµ‹å’Œç»´æŠ¤ã€‚'
    }

    if (activeMonths === 1) {
      return `é¢„è­¦ä¸»è¦é›†ä¸­åœ¨${peakMonth}ï¼Œå»ºè®®é‡ç‚¹å…³æ³¨è¯¥æ—¶æ®µçš„è®¾å¤‡çŠ¶æ€å’Œç¯å¢ƒå› ç´ ã€‚`
    }

    if (activeMonths <= 3) {
      return `é¢„è­¦ç›¸å¯¹é›†ä¸­ï¼Œå³°å€¼å‡ºç°åœ¨${peakMonth}ã€‚å»ºè®®åˆ†æé¢„è­¦é›†ä¸­æœŸçš„å…±åŒå› ç´ ï¼Œåˆ¶å®šé’ˆå¯¹æ€§é¢„é˜²æªæ–½ã€‚`
    }

    return `é¢„è­¦åˆ†å¸ƒè¾ƒä¸ºåˆ†æ•£ï¼Œå…¨å¹´å…±${activeMonths}ä¸ªæœˆå‡ºç°é¢„è­¦ã€‚å»ºè®®å»ºç«‹é•¿æœŸç›‘æµ‹æœºåˆ¶ï¼Œå®šæœŸè¯„ä¼°è®¾å¤‡çŠ¶æ€ã€‚`
  }

  private getRecommendation(): string {
    if (!this.warningMonthData) return 'å»ºè®®å®Œå–„æ•°æ®æ”¶é›†ï¼Œç¡®ä¿ç›‘æµ‹ç³»ç»Ÿæ­£å¸¸è¿è¡Œ'

    let totalWarnings = this.getYearTotalWarnings()
    let activeMonths = this.getActiveMonths()

    if (totalWarnings === 0) {
      return 'ç»§ç»­ä¿æŒç°æœ‰çš„ç»´æŠ¤æ ‡å‡†ï¼Œå»ºè®®å®šæœŸè¿›è¡Œé¢„é˜²æ€§æ£€æŸ¥ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œã€‚'
    }

    if (totalWarnings > 50) {
      return 'é¢„è­¦é¢‘æ¬¡è¾ƒé«˜ï¼Œå»ºè®®ï¼š1) åŠ å¼ºæ—¥å¸¸å·¡æ£€é¢‘ç‡ï¼›2) å‡çº§å…³é”®è®¾å¤‡ï¼›3) ä¼˜åŒ–é¢„è­¦é˜ˆå€¼è®¾ç½®ã€‚'
    }

    if (activeMonths > 6) {
      return 'é¢„è­¦æŒç»­æ—¶é—´è¾ƒé•¿ï¼Œå»ºè®®ï¼š1) æ·±å…¥åˆ†ææ ¹æœ¬åŸå› ï¼›2) åˆ¶å®šé•¿æœŸæ”¹è¿›è®¡åˆ’ï¼›3) åŠ å¼ºäººå‘˜åŸ¹è®­ã€‚'
    }

    return 'é¢„è­¦æƒ…å†µå¯æ§ï¼Œå»ºè®®ï¼š1) æŒç»­ç›‘æµ‹é¢„è­¦è¶‹åŠ¿ï¼›2) å®Œå–„åº”æ€¥å“åº”æœºåˆ¶ï¼›3) å®šæœŸå›é¡¾å’Œä¼˜åŒ–ã€‚'
  }
}


============================================================
æ–‡ä»¶: main\ets\view\earlyWarning\EarlyWarning.ets
============================================================

import request from '../../utils/httpUtils'
import promptAction from '@ohos.promptAction'

interface ApiResult {
  success: boolean
  message?: string
  data?: any
}

interface AlarmItem {
  alarmId: string
  structureName: string
  fabricateName: string
  detectionType: string
  alarmLevel: string
  alarmContent: string
  alarmTime: string
  updateTime: string
  status: number
}

interface AlarmListResult {
  total: number
  rows: AlarmItem[]
}

@Component
export struct EarlyWarning {
  @Link currentTab: string
  @State alarmList: AlarmItem[] = []
  @State loading: boolean = false
  @State refreshing: boolean = false
  @State filterStatus: number = -1 // -1: å…¨éƒ¨, 0: æœªå¤„ç†, 1: å·²å¤„ç†
  @State filterLevel: string = 'å…¨éƒ¨'
  @State selectedAlarm: AlarmItem | null = null
  @State showDialog: boolean = false
  @State filteredCount: number = 0 // æ·»åŠ ç­›é€‰ç»“æœè®¡æ•°

  aboutToAppear() {
    console.info('EarlyWarning ç»„ä»¶åˆå§‹åŒ–')
    this.initializeMockAlarms()
    this.loadAlarmList()
  }

  initializeMockAlarms() {
    this.alarmList = [
      {
        alarmId: 'ALARM_001_2024090215491',
        structureName: 'å—äº¬é•¿æ±Ÿå¤§æ¡¥',
        fabricateName: 'LA-1',
        detectionType: 'åº”åŠ›',
        alarmLevel: '3çº§',
        alarmContent: 'ä¼ æ„Ÿå™¨æµ‹é‡å€¼è¶…è¿‡3çº§å‘Šè­¦é˜ˆå€¼:è½¦é‡é‡‡é›†å€¼:52.1T,è¶…3çº§é˜ˆå€¼[50.0~75.0]',
        alarmTime: '2024-09-02T15:49:11',
        updateTime: '2024-09-02T15:49:24',
        status: 0
      },
      {
        alarmId: 'ALARM_002_2024090215543',
        structureName: 'é«˜é‚®æ¹–å¤§æ¡¥',
        fabricateName: 'LB-2',
        detectionType: 'ç´¢åŠ›',
        alarmLevel: '2çº§',
        alarmContent: 'ä¼ æ„Ÿå™¨æµ‹é‡å€¼è¶…è¿‡2çº§å‘Šè­¦é˜ˆå€¼:ç´¢åŠ›é‡‡é›†å€¼:180kN,è¶…2çº§é˜ˆå€¼[150.0~200.0]',
        alarmTime: '2024-09-02T15:54:38',
        updateTime: '2024-09-02T15:54:36',
        status: 1
      },
      {
        alarmId: 'ALARM_003_2024090310234',
        structureName: 'è‹é€šé•¿æ±Ÿå¤§æ¡¥',
        fabricateName: 'LC-3',
        detectionType: 'ä½ç§»',
        alarmLevel: '3çº§',
        alarmContent: 'ç»“æ„ä½ç§»å¼‚å¸¸:ä½ç§»å€¼:15.8mm,è¶…3çº§é˜ˆå€¼[15.0~20.0]',
        alarmTime: '2024-09-03T10:23:45',
        updateTime: '2024-09-03T10:23:45',
        status: 0
      },
      {
        alarmId: 'ALARM_004_2024090516552',
        structureName: 'æ¶¦æ‰¬é•¿æ±Ÿå¤§æ¡¥',
        fabricateName: 'LB-5',
        detectionType: 'ç´¢åŠ›',
        alarmLevel: '1çº§',
        alarmContent: 'ç´¢åŠ›è½»å¾®åå·®:ç´¢åŠ›å€¼:1180kN,æ¥è¿‘1çº§é˜ˆå€¼[1150~1250]',
        alarmTime: '2024-09-05T16:55:28',
        updateTime: '2024-09-05T17:02:45',
        status: 1
      },
      {
        alarmId: 'ALARM_005_2024090618321',
        structureName: 'æ³°å·é•¿æ±Ÿå¤§æ¡¥',
        fabricateName: 'LD-4',
        detectionType: 'æ¸©åº¦',
        alarmLevel: '3çº§',
        alarmContent: 'ç»“æ„æ¸©åº¦å¼‚å¸¸:æ¸©åº¦å€¼:65.2â„ƒ,è¶…3çº§é˜ˆå€¼[60.0~70.0]',
        alarmTime: '2024-09-06T18:32:15',
        updateTime: '2024-09-06T18:32:15',
        status: 0
      },
      {
        alarmId: 'ALARM_006_2024090712456',
        structureName: 'æ±Ÿé˜´é•¿æ±Ÿå¤§æ¡¥',
        fabricateName: 'LE-6',
        detectionType: 'æŒ¯åŠ¨',
        alarmLevel: '2çº§',
        alarmContent: 'æŒ¯åŠ¨é¢‘ç‡è¶…æ ‡:é¢‘ç‡å€¼:2.8Hz,è¶…2çº§é˜ˆå€¼[2.5~3.0]',
        alarmTime: '2024-09-07T12:45:32',
        updateTime: '2024-09-07T13:02:18',
        status: 1
      }
    ]

    console.info('æ¨¡æ‹Ÿæ•°æ®åˆå§‹åŒ–å®Œæˆï¼Œé¢„è­¦æ•°é‡:', this.alarmList.length)
    this.updateFilteredCount()
  }

  // æ›´æ–°ç­›é€‰è®¡æ•°
  private updateFilteredCount() {
    this.filteredCount = this.getFilteredAlarmList().length
    console.info(`ç­›é€‰æ›´æ–°: çŠ¶æ€=${this.filterStatus}, çº§åˆ«=${this.filterLevel}, ç»“æœæ•°=${this.filteredCount}`)
  }

  async loadAlarmList() {
    this.loading = true
    try {
      console.info('å¼€å§‹åŠ è½½é¢„è­¦åˆ—è¡¨...')
      let result = await request.post('/alarm/getList', {}) as ApiResult
      console.info('é¢„è­¦åˆ—è¡¨APIå“åº”:', JSON.stringify(result, null, 2))

      if (result?.success && result?.data) {
        let alarmData = result.data as AlarmListResult
        console.info('è§£æåçš„é¢„è­¦æ•°æ®:', JSON.stringify(alarmData, null, 2))

        if (alarmData?.rows && alarmData.rows.length > 0) {
          this.alarmList = alarmData.rows.map((item, index) => {
            console.info(`å¤„ç†ç¬¬${index + 1}æ¡é¢„è­¦æ•°æ®:`, JSON.stringify(item, null, 2))
            let processedItem = {
              alarmId: item.alarmId || '',
              structureName: item.structureName || 'æœªçŸ¥ç»“æ„ç‰©',
              fabricateName: item.fabricateName || 'æœªçŸ¥æ„ä»¶',
              detectionType: item.detectionType || 'æœªçŸ¥ç±»å‹',
              alarmLevel: item.alarmLevel || '1çº§',
              alarmContent: item.alarmContent || 'æš‚æ— è¯¦ç»†ä¿¡æ¯',
              alarmTime: item.alarmTime || new Date().toISOString(),
              updateTime: item.updateTime || new Date().toISOString(),
              status: typeof item.status === 'number' ? item.status : 0
            }
            console.info(`å¤„ç†åçš„ç¬¬${index + 1}æ¡æ•°æ®:`, JSON.stringify(processedItem, null, 2))
            return processedItem
          })
          console.info('é¢„è­¦åˆ—è¡¨åŠ è½½æˆåŠŸï¼Œæ•°é‡:', this.alarmList.length)
          this.updateFilteredCount()
        } else {
          console.warn('APIè¿”å›ç©ºæ•°æ®ï¼Œä¿ç•™æ¨¡æ‹Ÿæ•°æ®')
        }
      } else {
        console.warn('APIè°ƒç”¨å¤±è´¥ï¼Œä¿ç•™æ¨¡æ‹Ÿæ•°æ®:', result?.message)
      }
    } catch (error) {
      console.error('åŠ è½½é¢„è­¦åˆ—è¡¨å¤±è´¥:', error)
      promptAction.showToast({
        message: 'ç½‘ç»œå¼‚å¸¸ï¼Œæ˜¾ç¤ºæœ¬åœ°æ•°æ®',
        duration: 2000,
      })
    } finally {
      this.loading = false
      this.refreshing = false
    }
  }

  async handleAlarm(alarmId: string) {
    if (!alarmId || alarmId.trim() === '') {
      console.error('é¢„è­¦IDä¸ºç©º:', alarmId)
      promptAction.showToast({
        message: 'é¢„è­¦IDæ— æ•ˆï¼Œè¯·é‡è¯•',
        duration: 2000,
      })
      return
    }

    console.info('å¼€å§‹å¤„ç†é¢„è­¦ï¼ŒID:', alarmId)

    try {
      let requestParams = {
        alarmId: alarmId.trim()
      }

      console.info('è¯·æ±‚å‚æ•°:', JSON.stringify(requestParams, null, 2))

      let result = await request.post('/alarm/handle', requestParams) as ApiResult

      console.info('å¤„ç†é¢„è­¦å“åº”:', JSON.stringify(result, null, 2))

      if (result?.success) {
        promptAction.showToast({
          message: 'é¢„è­¦å¤„ç†æˆåŠŸ',
          duration: 2000,
        })

        let index = this.alarmList.findIndex(item => item.alarmId === alarmId)
        if (index !== -1) {
          this.alarmList[index].status = 1
          this.alarmList[index].updateTime = new Date().toISOString()
          console.info('æœ¬åœ°æ•°æ®å·²æ›´æ–°ï¼Œç´¢å¼•:', index)
          this.updateFilteredCount() // æ›´æ–°ç­›é€‰è®¡æ•°
        }
        this.showDialog = false
      } else {
        console.error('å¤„ç†é¢„è­¦å¤±è´¥ï¼ŒåŸå› :', result?.message)
        promptAction.showToast({
          message: result?.message || 'å¤„ç†å¤±è´¥',
          duration: 2000,
        })
      }
    } catch (error) {
      console.error('å¤„ç†é¢„è­¦å¼‚å¸¸:', error)
      promptAction.showToast({
        message: 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•',
        duration: 2000,
      })
    }
  }

  getFilteredAlarmList(): AlarmItem[] {
    return this.alarmList.filter(item => {
      let statusMatch = this.filterStatus === -1 || item.status === this.filterStatus
      let levelMatch = this.filterLevel === 'å…¨éƒ¨' || item.alarmLevel === this.filterLevel
      return statusMatch && levelMatch
    })
  }

  getAlarmLevelColor(level: string): string {
    switch (level) {
      case '1çº§': return '#52c41a'
      case '2çº§': return '#faad14'
      case '3çº§': return '#f5222d'
      default: return '#1890ff'
    }
  }

  getStatusText(status: number): string {
    return status === 0 ? 'æœªå¤„ç†' : 'å·²å¤„ç†'
  }

  getStatusColor(status: number): string {
    return status === 0 ? '#f5222d' : '#52c41a'
  }

  formatDateTime(dateStr: string): string {
    if (!dateStr) return 'æœªçŸ¥æ—¶é—´'
    try {
      let date = new Date(dateStr)
      if (isNaN(date.getTime())) return dateStr
      return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`
    } catch {
      return dateStr
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('é¢„è­¦ç®¡ç†')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')

        Blank()

        Button('åˆ·æ–°')
          .fontSize(14)
          .backgroundColor('#4852C9')
          .onClick(() => {
            console.info('ç”¨æˆ·ç‚¹å‡»é¢„è­¦åˆ·æ–°æŒ‰é’®')
            this.refreshing = true
            this.loadAlarmList()
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor('#f8f9fa')

      // ç­›é€‰å™¨ - æ”¹è¿›å¸ƒå±€å’Œäº¤äº’
      Column() {
        // çŠ¶æ€ç­›é€‰
        Row() {
          Text('çŠ¶æ€ç­›é€‰:')
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .margin({ right: 12 })

          ForEach([
            { label: 'å…¨éƒ¨', value: -1 },
            { label: 'æœªå¤„ç†', value: 0 },
            { label: 'å·²å¤„ç†', value: 1 }
          ], (item: { label: string, value: number }) => {
            Text(item.label)
              .fontSize(12)
              .fontColor(this.filterStatus === item.value ? '#fff' : '#666')
              .fontWeight(this.filterStatus === item.value ? FontWeight.Bold : FontWeight.Normal)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .backgroundColor(this.filterStatus === item.value ? '#4852C9' : '#f0f0f0')
              .borderRadius(16)
              .onClick(() => {
                console.info(`åˆ‡æ¢çŠ¶æ€ç­›é€‰: ${item.label} (${item.value})`)
                this.filterStatus = item.value
                this.updateFilteredCount()
              })
              .margin({ right: 8 })
          })
        }
        .width('100%')
        .margin({ bottom: 12 })

        // çº§åˆ«ç­›é€‰
        Row() {
          Text('çº§åˆ«ç­›é€‰:')
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .margin({ right: 12 })

          ForEach(['å…¨éƒ¨', '1çº§', '2çº§', '3çº§'], (level: string) => {
            Text(level)
              .fontSize(12)
              .fontColor(this.filterLevel === level ? '#fff' : '#666')
              .fontWeight(this.filterLevel === level ? FontWeight.Bold : FontWeight.Normal)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .backgroundColor(this.filterLevel === level ? this.getLevelFilterColor(level) : '#f0f0f0')
              .borderRadius(16)
              .onClick(() => {
                console.info(`åˆ‡æ¢çº§åˆ«ç­›é€‰: ${level}`)
                this.filterLevel = level
                this.updateFilteredCount()
              })
              .margin({ right: 8 })
          })
        }
        .width('100%')

        // ç­›é€‰ç»“æœæç¤º
        Row() {
          Text(`ç­›é€‰ç»“æœ: ${this.filteredCount} æ¡é¢„è­¦`)
            .fontSize(12)
            .fontColor('#666')
            .margin({ top: 8 })

          Blank()

          if (this.filterStatus !== -1 || this.filterLevel !== 'å…¨éƒ¨') {
            Text('æ¸…é™¤ç­›é€‰')
              .fontSize(12)
              .fontColor('#4852C9')
              .onClick(() => {
                this.filterStatus = -1
                this.filterLevel = 'å…¨éƒ¨'
                this.updateFilteredCount()
              })
          }
        }
        .width('100%')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor(Color.White)
      .border({
        width: { bottom: 1 },
        color: '#f0f0f0'
      })

      // ç»Ÿè®¡ä¿¡æ¯
      Row() {
        this.StatCard('æ€»é¢„è­¦', this.alarmList.length, '#1890ff')
        this.StatCard('æœªå¤„ç†', this.alarmList.filter(item => item.status === 0).length, '#f5222d')
        this.StatCard('å·²å¤„ç†', this.alarmList.filter(item => item.status === 1).length, '#52c41a')
        this.StatCard('3çº§é¢„è­¦', this.alarmList.filter(item => item.alarmLevel === '3çº§').length, '#ff4d4f')
      }
      .width('100%')
      .padding(16)
      .justifyContent(FlexAlign.SpaceBetween)
      .backgroundColor('#f8f9fa')

      // ä¸»è¦å†…å®¹åŒºåŸŸ - ä¿®å¤æ»šåŠ¨é—®é¢˜
      if (this.loading && !this.refreshing) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#4852C9')

          Text('åŠ è½½é¢„è­¦æ•°æ®ä¸­...')
            .fontSize(14)
            .fontColor('#666')
            .margin({ top: 8 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        // é¢„è­¦åˆ—è¡¨ - ä¼˜åŒ–å¸ƒå±€
        Refresh({ refreshing: this.refreshing, offset: 50, friction: 66 }) {
          if (this.getFilteredAlarmList().length === 0) {
            // ç©ºçŠ¶æ€
            Column() {
              Text('ğŸ“‹')
                .fontSize(60)
                .opacity(0.3)

              Text('æš‚æ— é¢„è­¦æ•°æ®')
                .fontSize(16)
                .fontColor('#999')
                .margin({ top: 16 })

              if (this.filterStatus !== -1 || this.filterLevel !== 'å…¨éƒ¨') {
                Text('å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ— æ•°æ®ï¼Œè¯·è°ƒæ•´ç­›é€‰æ¡ä»¶')
                  .fontSize(12)
                  .fontColor('#ccc')
                  .margin({ top: 8 })

                Button('æ¸…é™¤ç­›é€‰')
                  .fontSize(14)
                  .backgroundColor('#4852C9')
                  .margin({ top: 16 })
                  .onClick(() => {
                    this.filterStatus = -1
                    this.filterLevel = 'å…¨éƒ¨'
                    this.updateFilteredCount()
                  })
              } else {
                Text('è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•')
                  .fontSize(12)
                  .fontColor('#ccc')
                  .margin({ top: 8 })
              }
            }
            .width('100%')
            .height('100%')
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
          } else {
            // æœ‰æ•°æ®æ—¶æ˜¾ç¤ºåˆ—è¡¨
            List({ space: 8 }) {
              ForEach(this.getFilteredAlarmList(), (alarm: AlarmItem, index: number) => {
                ListItem() {
                  this.AlarmItemView(alarm, index)
                }
              })

              // æ·»åŠ åº•éƒ¨é—´è·ï¼Œç¡®ä¿æœ€åä¸€é¡¹å¯ä»¥å®Œå…¨æ˜¾ç¤º
              ListItem() {
                Column()
                  .width('100%')
                  .height(80)
              }
            }
            .width('100%')
            .height('100%')
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .scrollBar(BarState.Auto)
            .edgeEffect(EdgeEffect.Spring)
          }
        }
        .onRefreshing(() => {
          this.loadAlarmList()
        })
        .layoutWeight(1)
      }

      // é¢„è­¦è¯¦æƒ…å¯¹è¯æ¡†
      if (this.showDialog && this.selectedAlarm) {
        this.AlarmDetailDialog()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  // è·å–çº§åˆ«ç­›é€‰æŒ‰é’®é¢œè‰²
  private getLevelFilterColor(level: string): string {
    switch (level) {
      case '1çº§': return '#52c41a'
      case '2çº§': return '#faad14'
      case '3çº§': return '#f5222d'
      default: return '#4852C9'
    }
  }

  @Builder
  StatCard(title: string, count: number, color: string) {
    Column() {
      Text(count.toString())
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(12)
        .fontColor('#666')
        .margin({ top: 4 })
    }
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .width(80)
    .shadow({
      radius: 2,
      color: '#00000010',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  AlarmItemView(alarm: AlarmItem, index: number) {
    Column() {
      // å¤´éƒ¨ä¿¡æ¯
      Row() {
        Row() {
          Circle({ width: 8, height: 8 })
            .fill(this.getAlarmLevelColor(alarm.alarmLevel))
            .margin({ right: 6 })

          Text(alarm.alarmLevel || 'æœªçŸ¥çº§åˆ«')
            .fontSize(12)
            .fontColor(this.getAlarmLevelColor(alarm.alarmLevel))
            .fontWeight(FontWeight.Bold)
        }

        Blank()

        Row() {
          Text('#' + (index + 1))
            .fontSize(10)
            .fontColor('#999')
            .margin({ right: 8 })

          Text(this.getStatusText(alarm.status))
            .fontSize(12)
            .fontColor(this.getStatusColor(alarm.status))
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .backgroundColor(alarm.status === 0 ? '#fff2f0' : '#f6ffed')
            .borderRadius(10)
        }
      }
      .width('100%')
      .margin({ bottom: 8 })

      // ç»“æ„ç‰©ä¿¡æ¯
      Row() {
        Text(alarm.structureName || 'æœªçŸ¥ç»“æ„ç‰©')
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        if (alarm.fabricateName) {
          Text(' - ' + alarm.fabricateName)
            .fontSize(12)
            .fontColor('#666666')
        }

        Blank()

        Text(alarm.detectionType || 'æœªçŸ¥ç±»å‹')
          .fontSize(12)
          .fontColor('#1890ff')
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .backgroundColor('#e6f7ff')
          .borderRadius(10)
      }
      .width('100%')
      .margin({ bottom: 8 })

      // é¢„è­¦å†…å®¹
      Text(alarm.alarmContent || 'æš‚æ— è¯¦ç»†ä¿¡æ¯')
        .fontSize(13)
        .fontColor('#333333')
        .lineHeight(18)
        .width('100%')
        .margin({ bottom: 8 })
        .padding(8)
        .backgroundColor('#f8f9fa')
        .borderRadius(6)
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })

      // æ—¶é—´å’Œæ“ä½œ
      Row() {
        Column() {
          Text('é¢„è­¦æ—¶é—´: ' + this.formatDateTime(alarm.alarmTime))
            .fontSize(11)
            .fontColor('#999999')

          if (alarm.updateTime) {
            Text('æ›´æ–°æ—¶é—´: ' + this.formatDateTime(alarm.updateTime))
              .fontSize(11)
              .fontColor('#999999')
              .margin({ top: 2 })
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        Row() {
          Button('è¯¦æƒ…')
            .fontSize(12)
            .backgroundColor('#f0f0f0')
            .fontColor('#666')
            .padding({ left: 16, right: 16, top: 6, bottom: 6 })
            .constraintSize({ minWidth: 60 })
            .onClick(() => {
              this.selectedAlarm = alarm
              this.showDialog = true
            })

          if (alarm.status === 0) {
            Button('å¤„ç†')
              .fontSize(12)
              .backgroundColor('#4852C9')
              .fontColor(Color.White)
              .padding({ left: 16, right: 16, top: 6, bottom: 6 })
              .constraintSize({ minWidth: 60 })
              .margin({ left: 8 })
              .onClick(() => {
                console.info('ç‚¹å‡»å¤„ç†æŒ‰é’®ï¼Œé¢„è­¦ä¿¡æ¯:', alarm)

                if (!alarm.alarmId || alarm.alarmId.trim() === '') {
                  console.error('é¢„è­¦IDæ— æ•ˆ:', alarm.alarmId)
                  promptAction.showToast({
                    message: 'é¢„è­¦æ•°æ®å¼‚å¸¸ï¼Œè¯·åˆ·æ–°åé‡è¯•',
                    duration: 2000,
                  })
                  return
                }

                this.handleAlarm(alarm.alarmId)
              })
          }
        }
      }
      .width('100%')
      .alignItems(VerticalAlign.Bottom)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: '#00000008',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      this.selectedAlarm = alarm
      this.showDialog = true
    })
  }

  @Builder
  AlarmDetailDialog() {
    if (this.selectedAlarm) {
      // å…¨å±é®ç½©
      Stack() {
        // èƒŒæ™¯é®ç½©
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0,0,0,0.5)')
          .onClick(() => {
            this.showDialog = false
          })

        // å¯¹è¯æ¡†å†…å®¹
        Column() {
          // æ ‡é¢˜æ 
          Row() {
            Text('é¢„è­¦è¯¦æƒ…')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')

            Blank()

            Button('âœ•')
              .fontSize(16)
              .backgroundColor(Color.Transparent)
              .fontColor('#999')
              .padding(8)
              .onClick(() => {
                this.showDialog = false
              })
          }
          .width('100%')
          .padding({ bottom: 16 })

          // å†…å®¹åŒºåŸŸ
          Scroll() {
            Column() {
              this.DetailRow('é¢„è­¦ID', this.selectedAlarm.alarmId)
              this.DetailRow('ç»“æ„ç‰©', this.selectedAlarm.structureName)
              this.DetailRow('æ„ä»¶', this.selectedAlarm.fabricateName)
              this.DetailRow('ç›‘æµ‹ç±»å‹', this.selectedAlarm.detectionType)
              this.DetailRow('é¢„è­¦çº§åˆ«', this.selectedAlarm.alarmLevel, this.getAlarmLevelColor(this.selectedAlarm.alarmLevel))
              this.DetailRow('çŠ¶æ€', this.getStatusText(this.selectedAlarm.status), this.getStatusColor(this.selectedAlarm.status))
              this.DetailRow('é¢„è­¦æ—¶é—´', this.formatDateTime(this.selectedAlarm.alarmTime))
              this.DetailRow('æ›´æ–°æ—¶é—´', this.formatDateTime(this.selectedAlarm.updateTime))

              Column() {
                Text('é¢„è­¦å†…å®¹')
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#333')
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })

                Text(this.selectedAlarm.alarmContent)
                  .fontSize(14)
                  .fontColor('#666')
                  .lineHeight(20)
                  .width('100%')
                  .padding(12)
                  .backgroundColor('#f8f9fa')
                  .borderRadius(8)
              }
              .width('100%')
              .margin({ top: 16 })
            }
          }
          .layoutWeight(1)
          .scrollBar(BarState.Auto)

          // æ“ä½œæŒ‰é’®
          if (this.selectedAlarm.status === 0) {
            Row() {
              Button('å–æ¶ˆ')
                .fontSize(14)
                .backgroundColor('#f0f0f0')
                .fontColor('#666')
                .layoutWeight(1)
                .onClick(() => {
                  this.showDialog = false
                })

              Button('æ ‡è®°ä¸ºå·²å¤„ç†')
                .fontSize(14)
                .backgroundColor('#4852C9')
                .fontColor(Color.White)
                .layoutWeight(1)
                .margin({ left: 12 })
                .onClick(() => {
                  this.handleAlarm(this.selectedAlarm!.alarmId)
                })
            }
            .width('100%')
            .margin({ top: 16 })
          } else {
            Button('å…³é—­')
              .fontSize(14)
              .backgroundColor('#4852C9')
              .fontColor(Color.White)
              .width('100%')
              .margin({ top: 16 })
              .onClick(() => {
                this.showDialog = false
              })
          }
        }
        .width('90%')
        .constraintSize({ maxHeight: '80%' })
        .padding(20)
        .backgroundColor(Color.White)
        .borderRadius(16)
        .shadow({
          radius: 20,
          color: '#00000020',
          offsetX: 0,
          offsetY: 10
        })
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 })
      .zIndex(999)
    }
  }

  @Builder
  DetailRow(label: string, value: string, color?: string) {
    Row() {
      Text(label + ':')
        .fontSize(14)
        .fontColor('#333')
        .fontWeight(FontWeight.Bold)
        .width(80)

      Text(value || 'æš‚æ— ')
        .fontSize(14)
        .fontColor(color || '#666')
        .layoutWeight(1)
        .textAlign(TextAlign.Start)
    }
    .width('100%')
    .padding({ top: 8, bottom: 8 })
    .alignItems(VerticalAlign.Center)
  }
}


============================================================
æ–‡ä»¶: main\ets\view\login\LoginTab.ets
============================================================

import request from '../../utils/httpUtils'
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';

interface ApiResult {
  success: boolean
  message?: string
  data?: any
}

@Component
export struct LoginTab {
  @State userName: string = '18130075146'
  @State passWord: string = 'BHM123456'
  @State loginEnabled: boolean = true
  @State isLoading: boolean = false
  @State showPassword: boolean = false

  build() {
    Column() {
      // åº”ç”¨Logoå’Œæ ‡é¢˜
      Column() {
        Image($r('app.media.app_icon'))
          .width(80)
          .height(80)
          .borderRadius(16)
          .margin({ bottom: 16 })

        Text('æ¡¥æ¢ç›‘æ§ç³»ç»Ÿ')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .margin({ bottom: 8 })

        Text('Bridge Health Monitoring')
          .fontSize(14)
          .fontColor('#999')
          .margin({ bottom: 32 })
      }

      // ç™»å½•è¡¨å•
      Column() {
        Text('è´¦å·ç™»å½•')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .margin({ bottom: 24 })
          .alignSelf(ItemAlign.Start)

        // æ‰‹æœºå·è¾“å…¥æ¡†
        Column() {
          Text('æ‰‹æœºå·')
            .fontSize(14)
            .fontColor('#333')
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 8 })

          Row() {
            Image($r('app.media.icon'))
              .width(20)
              .height(20)
              .margin({ right: 12 })
              .fillColor('#999')

            TextInput({
              text: this.userName,
              placeholder: 'è¯·è¾“å…¥æ‰‹æœºå·'
            })
              .backgroundColor(Color.Transparent)
              .border({ width: 0 })
              .layoutWeight(1)
              .fontSize(16)
              .placeholderColor('#ccc')
              .onChange((value: string) => {
                this.userName = value;
                this.updateLoginEnabled();
              })
          }
          .width('100%')
          .height(48)
          .padding({ left: 16, right: 16 })
          .backgroundColor('#f8f9fa')
          .borderRadius(12)
          .border({
            width: 1,
            color: '#e8e8e8'
          })
        }
        .width('100%')
        .margin({ bottom: 20 })

        // å¯†ç è¾“å…¥æ¡†
        Column() {
          Text('å¯†ç ')
            .fontSize(14)
            .fontColor('#333')
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 8 })

          Row() {
            Image($r('app.media.icon'))
              .width(20)
              .height(20)
              .margin({ right: 12 })
              .fillColor('#999')

            TextInput({
              text: this.passWord,
              placeholder: 'è¯·è¾“å…¥å¯†ç '
            })
              .type(this.showPassword ? InputType.Normal : InputType.Password)
              .backgroundColor(Color.Transparent)
              .border({ width: 0 })
              .layoutWeight(1)
              .fontSize(16)
              .placeholderColor('#ccc')
              .onChange((value: string) => {
                this.passWord = value;
                this.updateLoginEnabled();
              })

            Image($r('app.media.icon'))
              .width(20)
              .height(20)
              .fillColor('#999')
              .onClick(() => {
                this.showPassword = !this.showPassword
              })
          }
          .width('100%')
          .height(48)
          .padding({ left: 16, right: 16 })
          .backgroundColor('#f8f9fa')
          .borderRadius(12)
          .border({
            width: 1,
            color: '#e8e8e8'
          })
        }
        .width('100%')
        .margin({ bottom: 32 })

        // ç™»å½•æŒ‰é’®
        Button() {
          if (this.isLoading) {
            Row() {
              LoadingProgress()
                .width(20)
                .height(20)
                .color(Color.White)
                .margin({ right: 8 })

              Text('ç™»å½•ä¸­...')
                .fontSize(16)
                .fontColor(Color.White)
            }
          } else {
            Text('ç«‹å³ç™»å½•')
              .fontSize(16)
              .fontColor(Color.White)
              .fontWeight(FontWeight.Bold)
          }
        }
        .width('100%')
        .height(48)
        .backgroundColor(this.loginEnabled && !this.isLoading ? '#4852C9' : '#ccc')
        .borderRadius(12)
        .enabled(this.loginEnabled && !this.isLoading)
        .onClick(() => {
          this.toLogin()
        })
        .margin({ bottom: 16 })

        // å…¶ä»–ç™»å½•æ–¹å¼æˆ–æç¤º
        Row() {
          Text('é¦–æ¬¡ä½¿ç”¨ï¼Ÿ')
            .fontSize(12)
            .fontColor('#999')

          Text('è”ç³»ç®¡ç†å‘˜è·å–è´¦å·')
            .fontSize(12)
            .fontColor('#4852C9')
            .margin({ left: 4 })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')
      .padding(24)
      .backgroundColor('rgba(255, 255, 255, 0.95)')
      .borderRadius(16)
      .backdropBlur(10)
    }
    .width('85%')
    .constraintSize({ maxWidth: 400 })
  }

  updateLoginEnabled() {
    this.loginEnabled = this.userName.length > 0 && this.passWord.length > 0
  }

  //ç™»å½•
  async toLogin() {
    if (!this.loginEnabled || this.isLoading) {
      return
    }

    // ç®€å•çš„æ‰‹æœºå·éªŒè¯
    const phoneRegex = /^1[3-9]\d{9}$/
    if (!phoneRegex.test(this.userName)) {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·',
        duration: 2000,
      });
      return
    }

    this.isLoading = true

    try {
      const params = {
        "userName": this.userName,
        "passWord": this.passWord,
        "port": 1
      }

      const result = await request.post('/account/login', params) as ApiResult

      if (result?.success) {
        //å­˜å‚¨ä¼šè¯
        const bhmToken = result?.data;
        PersistentStorage.PersistProp('bhm-token', bhmToken);

        promptAction.showToast({
          message: 'ç™»å½•æˆåŠŸ',
          duration: 1500,
        });

        // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
        setTimeout(() => {
          router.replaceUrl({
            url: 'pages/Home'
          })
        }, 1000)
      } else {
        promptAction.showToast({
          message: result?.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·å¯†ç ',
          duration: 2000,
        });
      }
    } catch (err) {
      console.log('ç™»å½•å¼‚å¸¸:', JSON.stringify(err))
      promptAction.showToast({
        message: 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•',
        duration: 2000,
      });
    } finally {
      this.isLoading = false
    }
  }
}


============================================================
æ–‡ä»¶: ohosTest\ets\test\Ability.test.ets
============================================================

import hilog from '@ohos.hilog';
import { describe, beforeAll, beforeEach, afterEach, afterAll, it, expect } from '@ohos/hypium'

export default function abilityTest() {
  describe('ActsAbilityTest', function () {
    // Defines a test suite. Two parameters are supported: test suite name and test suite function.
    beforeAll(function () {
      // Presets an action, which is performed only once before all test cases of the test suite start.
      // This API supports only one parameter: preset action function.
    })
    beforeEach(function () {
      // Presets an action, which is performed before each unit test case starts.
      // The number of execution times is the same as the number of test cases defined by **it**.
      // This API supports only one parameter: preset action function.
    })
    afterEach(function () {
      // Presets a clear action, which is performed after each unit test case ends.
      // The number of execution times is the same as the number of test cases defined by **it**.
      // This API supports only one parameter: clear action function.
    })
    afterAll(function () {
      // Presets a clear action, which is performed after all test cases of the test suite end.
      // This API supports only one parameter: clear action function.
    })
    it('assertContain',0, function () {
      // Defines a test case. This API supports three parameters: test case name, filter parameter, and test case function.
      hilog.info(0x0000, 'testTag', '%{public}s', 'it begin');
      let a = 'abc'
      let b = 'b'
      // Defines a variety of assertion methods, which are used to declare expected boolean conditions.
      expect(a).assertContain(b)
      expect(a).assertEqual(a)
    })
  })
}


============================================================
æ–‡ä»¶: ohosTest\ets\test\List.test.ets
============================================================

import abilityTest from './Ability.test'

export default function testsuite() {
  abilityTest()
}


============================================================
æ–‡ä»¶: ohosTest\ets\testability\TestAbility.ets
============================================================

import UIAbility from '@ohos.app.ability.UIAbility';
import AbilityDelegatorRegistry from '@ohos.app.ability.abilityDelegatorRegistry';
import hilog from '@ohos.hilog';
import { Hypium } from '@ohos/hypium';
import testsuite from '../test/List.test';
import window from '@ohos.window';

export default class TestAbility extends UIAbility {
    onCreate(want, launchParam) {
        hilog.info(0x0000, 'testTag', '%{public}s', 'TestAbility onCreate');
        hilog.info(0x0000, 'testTag', '%{public}s', 'want param:' + JSON.stringify(want) ?? '');
        hilog.info(0x0000, 'testTag', '%{public}s', 'launchParam:'+ JSON.stringify(launchParam) ?? '');
        var abilityDelegator: any
        abilityDelegator = AbilityDelegatorRegistry.getAbilityDelegator()
        var abilityDelegatorArguments: any
        abilityDelegatorArguments = AbilityDelegatorRegistry.getArguments()
        hilog.info(0x0000, 'testTag', '%{public}s', 'start run testcase!!!');
        Hypium.hypiumTest(abilityDelegator, abilityDelegatorArguments, testsuite)
    }

    onDestroy() {
        hilog.info(0x0000, 'testTag', '%{public}s', 'TestAbility onDestroy');
    }

    onWindowStageCreate(windowStage: window.WindowStage) {
        hilog.info(0x0000, 'testTag', '%{public}s', 'TestAbility onWindowStageCreate');
        windowStage.loadContent('testability/pages/Index', (err, data) => {
            if (err.code) {
                hilog.error(0x0000, 'testTag', 'Failed to load the content. Cause: %{public}s', JSON.stringify(err) ?? '');
                return;
            }
            hilog.info(0x0000, 'testTag', 'Succeeded in loading the content. Data: %{public}s',
                JSON.stringify(data) ?? '');
        });
    }

    onWindowStageDestroy() {
        hilog.info(0x0000, 'testTag', '%{public}s', 'TestAbility onWindowStageDestroy');
    }

    onForeground() {
        hilog.info(0x0000, 'testTag', '%{public}s', 'TestAbility onForeground');
    }

    onBackground() {
        hilog.info(0x0000, 'testTag', '%{public}s', 'TestAbility onBackground');
    }
}


============================================================
æ–‡ä»¶: ohosTest\ets\testability\pages\Index.ets
============================================================

import hilog from '@ohos.hilog';

@Entry
@Component
struct Index {
  aboutToAppear() {
    hilog.info(0x0000, 'testTag', '%{public}s', 'TestAbility index aboutToAppear');
  }
 @State message: string = 'Hello World'
   build() {
         Row() {
           Column() {
             Text(this.message)
               .fontSize(50)
               .fontWeight(FontWeight.Bold)
             Button() {
               Text('next page')
                 .fontSize(20)
                 .fontWeight(FontWeight.Bold)
             }.type(ButtonType.Capsule)
             .margin({
               top: 20
             })
             .backgroundColor('#0D9FFB')
             .width('35%')
             .height('5%')
             .onClick(()=>{
             })
           }
             .width('100%')
         }
             .height('100%')
   }
 }

